<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>
  File: README.ja
  
    &mdash; Sinatra API Documentation
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!file.README.ja.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README.ja</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><div id='filecontents'><h1>Sinatra</h1>

<p><em>注）
本文書は英語から翻訳したものであり、その内容が最新でない場合もあります。最新の情報はオリジナルの英語版を参照して下さい。</em></p>

<p>Sinatraは最小の労力でRubyによるWebアプリケーションを手早く作るための<a href="http://ja.wikipedia.org/wiki/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%9B%BA%E6%9C%89%E8%A8%80%E8%AA%9E">DSL</a>です。</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># myapp.rb
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra</span><span class='tstring_end'>'</span></span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hello world!</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>gemをインストールし、</p>

<pre class="code shell"><code class="shell">gem install sinatra
</code></pre>

<p>次のように実行します。</p>

<pre class="code shell"><code class="shell">ruby myapp.rb
</code></pre>

<p><a href="http://localhost:4567">localhost:4567</a> を開きます。</p>

<p>ThinがあればSinatraはこれを利用するので、<code>gem install thin</code>することをお薦めします。</p>

<h2>目次</h2>

<ul>
<li><a href="#sinatra">Sinatra</a>

<ul>
<li><a href="#%E7%9B%AE%E6%AC%A1">目次</a></li>
<li><a href="#%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0routes">ルーティング(Routes)</a></li>
<li><a href="#%E6%9D%A1%E4%BB%B6conditions">条件(Conditions)</a></li>
<li><a href="#%E6%88%BB%E3%82%8A%E5%80%A4return-values">戻り値(Return Values)</a></li>
<li><a href="#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%83%9E%E3%83%83%E3%83%81%E3%83%A3%E3%83%BCcustom-route-matchers">カスタムルーティングマッチャー(Custom Route Matchers)</a></li>
<li><a href="#%E9%9D%99%E7%9A%84%E3%83%95%E3%82%A1%E3%82%A4%E3%83%ABstatic-files">静的ファイル(Static Files)</a></li>
<li><a href="#%E3%83%93%E3%83%A5%E3%83%BC--%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88views--templates">ビュー / テンプレート(Views / Templates)</a>

<ul>
<li><a href="#%E3%83%AA%E3%83%86%E3%83%A9%E3%83%AB%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88literal-templates">リテラルテンプレート(Literal Templates)</a></li>
<li><a href="#%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E8%A8%80%E8%AA%9E">利用可能なテンプレート言語</a>

<ul>
<li><a href="#haml-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Haml テンプレート</a></li>
<li><a href="#erb-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Erb テンプレート</a></li>
<li><a href="#builder-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Builder テンプレート</a></li>
<li><a href="#nokogiri-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Nokogiri テンプレート</a></li>
<li><a href="#sass-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Sass テンプレート</a></li>
<li><a href="#scss-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">SCSS テンプレート</a></li>
<li><a href="#less-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Less テンプレート</a></li>
<li><a href="#liquid-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Liquid テンプレート</a></li>
<li><a href="#markdown-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Markdown テンプレート</a></li>
<li><a href="#textile-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Textile テンプレート</a></li>
<li><a href="#rdoc-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">RDoc テンプレート</a></li>
<li><a href="#asciidoc-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">AsciiDoc テンプレート</a></li>
<li><a href="#radius-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Radius テンプレート</a></li>
<li><a href="#markaby-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Markaby テンプレート</a></li>
<li><a href="#rabl-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">RABL テンプレート</a></li>
<li><a href="#slim-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Slim テンプレート</a></li>
<li><a href="#creole-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Creole テンプレート</a></li>
<li><a href="#mediawiki-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">MediaWiki テンプレート</a></li>
<li><a href="#coffeescript-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">CoffeeScript テンプレート</a></li>
<li><a href="#stylus-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Stylus テンプレート</a></li>
<li><a href="#yajl-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">Yajl テンプレート</a></li>
<li><a href="#wlang-%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88">WLang テンプレート</a></li>
</ul></li>
<li><a href="#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E5%86%85%E3%81%A7%E3%81%AE%E5%A4%89%E6%95%B0%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9">テンプレート内での変数へのアクセス</a></li>
<li><a href="#yield%E3%82%92%E4%BC%B4%E3%81%86%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%81%A8%E3%83%8D%E3%82%B9%E3%83%88%E3%81%97%E3%81%9F%E3%83%AC%E3%82%A4%E3%82%A2%E3%82%A6%E3%83%88"><code>yield</code>を伴うテンプレートとネストしたレイアウト</a></li>
<li><a href="#%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88inline-templates">インラインテンプレート(Inline Templates)</a></li>
<li><a href="#%E5%90%8D%E5%89%8D%E4%BB%98%E3%81%8D%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88named-templates">名前付きテンプレート(Named Templates)</a></li>
<li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%8B%A1%E5%BC%B5%E5%AD%90%E3%81%AE%E9%96%A2%E9%80%A3%E4%BB%98%E3%81%91">ファイル拡張子の関連付け</a></li>
<li><a href="#%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%8A%E3%83%AB%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%81%AE%E8%BF%BD%E5%8A%A0">オリジナルテンプレートエンジンの追加</a></li>
</ul></li>
<li><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BFfilters">フィルタ(Filters)</a></li>
<li><a href="#%E3%83%98%E3%83%AB%E3%83%91%E3%83%BChelpers">ヘルパー(Helpers)</a>

<ul>
<li><a href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E4%BD%BF%E7%94%A8">セッションの使用</a></li>
<li><a href="#%E5%81%9C%E6%AD%A2halting">停止(Halting)</a></li>
<li><a href="#%E3%83%91%E3%83%83%E3%82%B7%E3%83%B3%E3%82%B0passing">パッシング(Passing)</a></li>
<li><a href="#%E5%88%A5%E3%83%AB%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E8%AA%98%E7%99%BA">別ルーティングの誘発</a></li>
<li><a href="#%E3%83%9C%E3%83%87%E3%82%A3%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%8A%E3%82%88%E3%81%B3%E3%83%98%E3%83%83%E3%83%80%E3%81%AE%E8%A8%AD%E5%AE%9A">ボディ、ステータスコードおよびヘッダの設定</a></li>
<li><a href="#%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9streaming-responses">ストリーミングレスポンス(Streaming Responses)</a></li>
<li><a href="#%E3%83%AD%E3%82%AE%E3%83%B3%E3%82%B0logging">ロギング(Logging)</a></li>
<li><a href="#mime%E3%82%BF%E3%82%A4%E3%83%97mime-types">MIMEタイプ(Mime Types)</a></li>
<li><a href="#url%E3%81%AE%E7%94%9F%E6%88%90">URLの生成</a></li>
<li><a href="#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88browser-redirect">ブラウザリダイレクト(Browser Redirect)</a></li>
<li><a href="#%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E5%88%B6%E5%BE%A1cache-control">キャッシュ制御(Cache Control)</a></li>
<li><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E9%80%81%E4%BF%A1">ファイルの送信</a></li>
<li><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%B8%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9">リクエストオブジェクトへのアクセス</a></li>
<li><a href="#%E3%82%A2%E3%82%BF%E3%83%83%E3%83%81%E3%83%A1%E3%83%B3%E3%83%88attachments">アタッチメント(Attachments)</a></li>
<li><a href="#%E6%97%A5%E4%BB%98%E3%81%A8%E6%99%82%E5%88%BB%E3%81%AE%E5%8F%96%E3%82%8A%E6%89%B1%E3%81%84">日付と時刻の取り扱い</a></li>
<li><a href="#%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%8E%A2%E7%B4%A2">テンプレートファイルの探索</a></li>
</ul></li>
<li><a href="#%E3%82%B3%E3%83%B3%E3%83%95%E3%82%A3%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3configuration">コンフィギュレーション(Configuration)</a>

<ul>
<li><a href="#%E6%94%BB%E6%92%83%E9%98%B2%E5%BE%A1%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E8%A8%AD%E5%AE%9A">攻撃防御に対する設定</a></li>
<li><a href="#%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E8%A8%AD%E5%AE%9A">利用可能な設定</a></li>
</ul></li>
<li><a href="#%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9Aenvironments">環境設定(Environments)</a></li>
<li><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0error-handling">エラーハンドリング(Error Handling)</a>

<ul>
<li><a href="#not-found">Not Found</a></li>
<li><a href="#%E3%82%A8%E3%83%A9%E3%83%BCerror">エラー(Error)</a></li>
</ul></li>
<li><a href="#rack%E3%83%9F%E3%83%89%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2rack-middleware">Rackミドルウェア(Rack Middleware)</a></li>
<li><a href="#%E3%83%86%E3%82%B9%E3%83%88testing">テスト(Testing)</a></li>
<li><a href="#sinatrabase---%E3%83%9F%E3%83%89%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%8A%E3%82%88%E3%81%B3%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%A9%E3%83%BC%E3%82%A2%E3%83%97%E3%83%AA">Sinatra::Base - ミドルウェア、ライブラリおよびモジュラーアプリ</a>

<ul>
<li><a href="#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%A9%E3%83%BC%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB-vs-%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%83%E3%82%AF%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB">モジュラースタイル vs クラッシックスタイル</a></li>
<li><a href="#%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%A9%E3%83%BC%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E6%8F%90%E4%BE%9B">モジュラーアプリケーションの提供</a></li>
<li><a href="#configru%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E3%82%AF%E3%83%A9%E3%83%83%E3%82%B7%E3%83%83%E3%82%AF%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E4%BD%BF%E7%94%A8">config.ruを用いたクラッシックスタイルアプリケーションの使用</a></li>
<li><a href="#configru%E3%81%AF%E3%81%84%E3%81%A4%E4%BD%BF%E3%81%86%E3%81%AE%E3%81%8B">config.ruはいつ使うのか？</a></li>
<li><a href="#sinatra%E3%81%AE%E3%83%9F%E3%83%89%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%A8%E3%81%97%E3%81%A6%E3%81%AE%E5%88%A9%E7%94%A8">Sinatraのミドルウェアとしての利用</a></li>
<li><a href="#%E5%8B%95%E7%9A%84%E3%81%AA%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%94%9F%E6%88%90">動的なアプリケーションの生成</a></li>
</ul></li>
<li><a href="#%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97%E3%81%A8%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0scopes-and-binding">スコープとバインディング(Scopes and Binding)</a>

<ul>
<li><a href="#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%AE%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97">アプリケーション/クラスのスコープ</a></li>
<li><a href="#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%A4%E3%83%B3%E3%82%B9%E3%82%BF%E3%83%B3%E3%82%B9%E3%81%AE%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97">リクエスト/インスタンスのスコープ</a></li>
<li><a href="#%E3%83%87%E3%83%AA%E3%82%B2%E3%83%BC%E3%83%88%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97">デリゲートスコープ</a></li>
</ul></li>
<li><a href="#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3">コマンドライン</a></li>
<li><a href="#%E5%BF%85%E8%A6%81%E7%92%B0%E5%A2%83">必要環境</a></li>
<li><a href="#%E6%9C%80%E6%96%B0%E9%96%8B%E7%99%BA%E7%89%88">最新開発版</a>

<ul>
<li><a href="#bundler%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88">Bundlerを使う場合</a></li>
<li><a href="#%E7%9B%B4%E6%8E%A5%E7%B5%84%E3%81%BF%E8%BE%BC%E3%82%80%E5%A0%B4%E5%90%88">直接組み込む場合</a></li>
<li><a href="#%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E7%92%B0%E5%A2%83%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88">グローバル環境にインストールする場合</a></li>
</ul></li>
<li><a href="#%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%8B%E3%83%B3%E3%82%B0versioning">バージョニング(Versioning)</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE">参考文献</a></li>
</ul></li>
</ul>

<h2>ルーティング(Routes)</h2>

<p>Sinatraでは、ルーティングはHTTPメソッドとURLマッチングパターンがペアになっています。
ルーティングはブロックに結び付けられています。</p>

<pre class="code ruby"><code class="ruby">get '/' do
  .. 何か見せる ..
end

post '/' do
  .. 何か生成する ..
end

put '/' do
  .. 何か更新する ..
end

patch '/' do
  .. 何か修正する ..
end

delete '/' do
  .. 何か削除する ..
end

options '/' do
  .. 何か満たす ..
end

link '/' do
  .. 何かリンクを張る ..
end

unlink '/' do
  .. 何かアンリンクする ..
end
</code></pre>

<p>ルーティングは定義された順番にマッチします。
リクエストに最初にマッチしたルーティングが呼び出されます。</p>

<p>ルーティングのパターンは名前付きパラメータを含むことができ、
<code>params</code>ハッシュで取得できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/hello/:name</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='comment'># &quot;GET /hello/foo&quot; と &quot;GET /hello/bar&quot; にマッチ
</span>  <span class='comment'># params['name'] は 'foo' か 'bar'
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>また、ブロックパラメータで名前付きパラメータにアクセスすることもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/hello/:name</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='op'>|</span>
  <span class='comment'># &quot;GET /hello/foo&quot; と &quot;GET /hello/bar&quot; にマッチ
</span>  <span class='comment'># params['name'] は 'foo' か 'bar'
</span>  <span class='comment'># n が params['name'] を保持
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_n'>n</span><span class='rbrace'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>ルーティングパターンはアスタリスク(すなわちワイルドカード)を含むこともでき、
<code>params[&#39;splat&#39;]</code> で取得できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/say/*/to/*</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='comment'># /say/hello/to/world にマッチ
</span>  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>splat</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='comment'># =&gt; [&quot;hello&quot;, &quot;world&quot;]
</span><span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/download/*.*</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='comment'># /download/path/to/file.xml にマッチ
</span>  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>splat</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='comment'># =&gt; [&quot;path/to/file&quot;, &quot;xml&quot;]
</span><span class='kw'>end</span>
</code></pre>

<p>ここで、ブロックパラメータを使うこともできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/download/*.*</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_ext'>ext</span><span class='op'>|</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_ext'>ext</span><span class='rbracket'>]</span> <span class='comment'># =&gt; [&quot;path/to/file&quot;, &quot;xml&quot;]
</span><span class='kw'>end</span>
</code></pre>

<p>ルーティングを正規表現にマッチさせることもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A\/hello\/([\w]+)\z</span><span class='regexp_end'>/</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>captures</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rbrace'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>ここでも、ブロックパラメータが使えます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='regexp_beg'>%r{</span><span class='tstring_content'>/hello/([\w]+)</span><span class='regexp_end'>}</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_c'>c</span><span class='rbrace'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>ルーティングパターンは、オプショナルパラメータを取ることもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/posts.?:format?</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='comment'># &quot;GET /posts&quot; と &quot;GET /posts.json&quot;, &quot;GET /posts.xml&quot; の拡張子などにマッチ
</span><span class='kw'>end</span>
</code></pre>

<p>ところで、ディレクトリトラバーサル攻撃防御設定を無効にしないと（下記参照）、
ルーティングにマッチする前にリクエストパスが修正される可能性があります。</p>

<h2>条件(Conditions)</h2>

<p>ルーティングにはユーザエージェントのようなさまざまな条件を含めることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:agent</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>Songbird (\d\.\d)[\d\/]*?</span><span class='regexp_end'>/</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Songbirdのバージョン </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>agent</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>を使ってます。</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='comment'># Songbird以外のブラウザにマッチ
</span><span class='kw'>end</span>
</code></pre>

<p>ほかに<code>host_name</code>と<code>provides</code>条件が利用可能です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:host_name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^admin\.</span><span class='regexp_end'>/</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Adminエリアです。アクセスを拒否します!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:provides</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>html</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='symbol'>:index</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:provides</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rss</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>atom</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>xml</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_builder'>builder</span> <span class='symbol'>:feed</span>
<span class='kw'>end</span>
</code></pre>

<p>独自の条件を定義することも簡単にできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='symbol'>:probability</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_value'>value</span><span class='op'>|</span> <span class='id identifier rubyid_condition'>condition</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_rand'>rand</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_value'>value</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/win_a_car</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:probability</span> <span class='op'>=&gt;</span> <span class='float'>0.1</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>あなたの勝ちです!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/win_a_car</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>残念、あなたの負けです。</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>複数の値を取る条件には、アスタリスクを使います。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='symbol'>:auth</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='op'>*</span><span class='id identifier rubyid_roles'>roles</span><span class='op'>|</span>   <span class='comment'># &lt;- ここでアスタリスクを使う
</span>  <span class='id identifier rubyid_condition'>condition</span> <span class='kw'>do</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_logged_in?'>logged_in?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_roles'>roles</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_role'>role</span><span class='op'>|</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='period'>.</span><span class='id identifier rubyid_in_role?'>in_role?</span> <span class='id identifier rubyid_role'>role</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_redirect'>redirect</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/login/</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>303</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/my/account/</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:auth</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='symbol'>:user</span><span class='comma'>,</span> <span class='symbol'>:admin</span><span class='rbracket'>]</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>アカウントの詳細</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/only/admin/</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:auth</span> <span class='op'>=&gt;</span> <span class='symbol'>:admin</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ここは管理者だけ!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h2>戻り値(Return Values)</h2>

<p>ルーティングブロックの戻り値は、HTTPクライアントまたはRackスタックでの次のミドルウェアに渡されるレスポンスボディを決定します。</p>

<p>これは大抵の場合、上の例のように文字列ですが、それ以外の値も使用することができます。</p>

<p>Rackレスポンス、Rackボディオブジェクト、HTTPステータスコードのいずれかとして妥当なオブジェクトであればどのようなオブジェクトでも返すことができます。</p>

<ul>
<li>3つの要素を含む配列:
<code>[ステータス(Fixnum), ヘッダ(Hash), レスポンスボディ(#eachに応答する)]</code></li>
<li>2つの要素を含む配列:
<code>[ステータス(Fixnum), レスポンスボディ(#eachに応答する)]</code></li>
<li><code>#each</code>に応答するオブジェクト。通常はそのまま何も返さないが、
与えられたブロックに文字列を渡す。</li>
<li>ステータスコードを表現する整数(Fixnum)</li>
</ul>

<p>これにより、例えばストリーミングを簡単に実装することができます。</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>Stream</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_each'>each</span>
    <span class='int'>100</span><span class='period'>.</span><span class='id identifier rubyid_times'>times</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_i'>i</span><span class='op'>|</span> <span class='kw'>yield</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='rbrace'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>Stream</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='rbrace'>}</span>
</code></pre>

<p>後述する<code>stream</code>ヘルパーメソッドを使って、定型パターンを減らしつつストリーミングロジックをルーティングに埋め込むこともできます。</p>

<h2>カスタムルーティングマッチャー(Custom Route Matchers)</h2>

<p>先述のようにSinatraはルーティングマッチャーとして、文字列パターンと正規表現を使うことをビルトインでサポートしています。しかしこれに留まらず、独自のマッチャーを簡単に定義することもできるのです。</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>AllButPattern</span>
  <span class='const'>Match</span> <span class='op'>=</span> <span class='const'>Struct</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='symbol'>:captures</span><span class='rparen'>)</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_except'>except</span><span class='rparen'>)</span>
    <span class='ivar'>@except</span>   <span class='op'>=</span> <span class='id identifier rubyid_except'>except</span>
    <span class='ivar'>@captures</span> <span class='op'>=</span> <span class='const'>Match</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
    <span class='ivar'>@captures</span> <span class='kw'>unless</span> <span class='ivar'>@except</span> <span class='op'>===</span> <span class='id identifier rubyid_str'>str</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>def</span> <span class='id identifier rubyid_all_but'>all_but</span><span class='lparen'>(</span><span class='id identifier rubyid_pattern'>pattern</span><span class='rparen'>)</span>
  <span class='const'>AllButPattern</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_pattern'>pattern</span><span class='rparen'>)</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='id identifier rubyid_all_but'>all_but</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/index</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<p>ノート: この例はオーバースペックであり、以下のようにも書くことができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='regexp_end'>/</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_pass'>pass</span> <span class='kw'>if</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_path_info'>path_info</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/index</span><span class='tstring_end'>&quot;</span></span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<p>または、否定先読みを使って:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='regexp_beg'>%r{</span><span class='tstring_content'>^(?!/index$)</span><span class='regexp_end'>}</span></span> <span class='kw'>do</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<h2>静的ファイル(Static Files)</h2>

<p>静的ファイルは<code>./public</code>ディレクトリから配信されます。
<code>:public_folder</code>オプションを指定することで別の場所を指定することができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:public_folder</span><span class='comma'>,</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_dirname'>dirname</span><span class='lparen'>(</span><span class='kw'>__FILE__</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/static</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>ノート: この静的ファイル用のディレクトリ名はURL中に含まれません。
例えば、<code>./public/css/style.css</code>は<code>http://example.com/css/style.css</code>でアクセスできます。</p>

<p><code>Cache-Control</code>の設定をヘッダーへ追加するには<code>:static_cache_control</code>の設定(下記参照)を加えてください。</p>

<h2>ビュー / テンプレート(Views / Templates)</h2>

<p>各テンプレート言語はそれ自身のレンダリングメソッドを通して展開されます。それらのメソッドは単に文字列を返します。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:index</span>
<span class='kw'>end</span>
</code></pre>

<p>これは、<code>views/index.erb</code>をレンダリングします。</p>

<p>テンプレート名を渡す代わりに、直接そのテンプレートの中身を渡すこともできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_code'>code</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;%= Time.now %&gt;</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='id identifier rubyid_code'>code</span>
<span class='kw'>end</span>
</code></pre>

<p>テンプレートのレイアウトは第２引数のハッシュ形式のオプションをもとに表示されます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:index</span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='symbol'>:post</span>
<span class='kw'>end</span>
</code></pre>

<p>これは、<code>views/post.erb</code>内に埋め込まれた<code>views/index.erb</code>をレンダリングします（デフォルトは<code>views/layout.erb</code>があればそれになります）。</p>

<p>Sinatraが理解できないオプションは、テンプレートエンジンに渡されることになります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='symbol'>:index</span><span class='comma'>,</span> <span class='symbol'>:format</span> <span class='op'>=&gt;</span> <span class='symbol'>:html5</span>
<span class='kw'>end</span>
</code></pre>

<p>テンプレート言語ごとにオプションをセットすることもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:haml</span><span class='comma'>,</span> <span class='symbol'>:format</span> <span class='op'>=&gt;</span> <span class='symbol'>:html5</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='symbol'>:index</span>
<span class='kw'>end</span>
</code></pre>

<p>レンダリングメソッドに渡されたオプションは<code>set</code>で設定されたオプションを上書きします。</p>

<p>利用可能なオプション:</p>

<dl>
  <dt>locals</dt>
  <dd>
    ドキュメントに渡されるローカルのリスト。パーシャルに便利。
    例: <tt>erb "<%= foo %>", :locals => {:foo => "bar"}</tt>
  </dd>

  <dt>default_encoding</dt>
  <dd>
    文字エンコーディング（不確かな場合に使用される）。デフォルトは、<tt>settings.default_encoding</tt>。
  </dd>

  <dt>views</dt>
  <dd>
    テンプレートを読み出すビューのディレクトリ。デフォルトは、<tt>settings.views</tt>。
  </dd>

  <dt>layout</dt>
  <dd>
    レイアウトを使うかの指定(<tt>true</tt> または <tt>false</tt>)。値がシンボルの場合は、使用するテンプレートが指定される。例: <tt>erb :index, :layout => !request.xhr?</tt>
  </dd>

  <dt>content_type</dt>
  <dd>
    テンプレートが生成するContent-Type。デフォルトはテンプレート言語ごとに異なる。
  </dd>

  <dt>scope</dt>
  <dd>
    テンプレートをレンダリングするときのスコープ。デフォルトは、アプリケーションのインスタンス。これを変更した場合、インスタンス変数およびヘルパーメソッドが利用できなくなる。
  </dd>

  <dt>layout_engine</dt>
  <dd>
    レイアウトをレンダリングするために使用するテンプレートエンジン。レイアウトをサポートしない言語で有用。デフォルトはテンプレートに使われるエンジン。例: <tt>set :rdoc, :layout_engine => :erb</tt>
  </dd>

  <dt>layout_options</dt>
  <dd>
    レイアウトをレンダリングするときだけに使う特別なオプション。例:
    <tt>set :rdoc, :layout_options => { :views => 'views/layouts' }</tt>
  </dd>
</dl>

<p>テンプレートは<code>./views</code>ディレクトリ下に配置されています。
他のディレクトリを使用する場合の例:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:views</span><span class='comma'>,</span> <span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_root'>root</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/templates</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>テンプレートはシンボルを使用して参照させることを覚えておいて下さい。
サブディレクトリでもこの場合は<code>:&#39;subdir/template&#39;</code>のようにします。
レンダリングメソッドは文字列が渡されると、それをそのまま文字列として出力するので、シンボルを使ってください。</p>

<h3>リテラルテンプレート(Literal Templates)</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>%div.title Hello World</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>これはそのテンプレート文字列をレンダリングします。</p>

<h3>利用可能なテンプレート言語</h3>

<p>いくつかの言語には複数の実装があります。使用する（そしてスレッドセーフにする）実装を指定するには、それを最初にrequireしてください。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rdiscount</span><span class='tstring_end'>'</span></span> <span class='comment'># または require 'bluecloth'
</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_markdown'>markdown</span> <span class='symbol'>:index</span> <span class='rbrace'>}</span>
</code></pre>

<h4>Haml テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://haml.info/" title="haml">haml</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.haml</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>haml :index, :format => :html5</tt></td>
  </tr>
</table>

<h4>Erb テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="http://www.kuwata-lab.com/erubis/" title="erubis">erubis</a>
      または erb (Rubyに同梱)
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.erb</tt>, <tt>.rhtml</tt> or <tt>.erubis</tt> (Erubisだけ)</td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>erb :index</tt></td>
  </tr>
</table>

<h4>Builder テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="https://github.com/jimweirich/builder" title="builder">builder</a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.builder</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>builder { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>

<p>インラインテンプレート用にブロックを取ることもできます（例を参照）。</p>

<h4>Nokogiri テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://nokogiri.org/" title="nokogiri">nokogiri</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.nokogiri</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>nokogiri { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>

<p>インラインテンプレート用にブロックを取ることもできます（例を参照）。</p>

<h4>Sass テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.sass</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>sass :stylesheet, :style => :expanded</tt></td>
  </tr>
</table>

<h4>Scss テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.scss</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>scss :stylesheet, :style => :expanded</tt></td>
  </tr>
</table>

<h4>Less テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://www.lesscss.org/" title="less">less</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.less</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>less :stylesheet</tt></td>
  </tr>
</table>

<h4>Liquid テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://www.liquidmarkup.org/" title="liquid">liquid</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.liquid</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>liquid :index, :locals => { :key => 'value' }</tt></td>
  </tr>
</table>

<p>LiquidテンプレートからRubyのメソッド(<code>yield</code>を除く)を呼び出すことができないため、ほぼ全ての場合にlocalsを指定する必要があるでしょう。</p>

<h4>Markdown テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      次の何れか:
        <a href="https://github.com/rtomayko/rdiscount" title="RDiscount">RDiscount</a>,
        <a href="https://github.com/vmg/redcarpet" title="RedCarpet">RedCarpet</a>,
        <a href="http://deveiate.org/projects/BlueCloth" title="BlueCloth">BlueCloth</a>,
        <a href="http://kramdown.gettalong.org/" title="kramdown">kramdown</a>,
        <a href="https://github.com/bhollis/maruku" title="maruku">maruku</a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.markdown</tt>, <tt>.mkd</tt> and <tt>.md</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>markdown :index, :layout_engine => :erb</tt></td>
  </tr>
</table>

<p>Markdownからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:overview</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_markdown'>markdown</span><span class='lparen'>(</span><span class='symbol'>:introduction</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
</code></pre>

<p>ノート: 他のテンプレート内で<code>markdown</code>メソッドを呼び出せます。</p>

<pre class="code ruby"><code class="ruby">%h1 Hello From Haml!
%p= markdown(:greetings)
</code></pre>

<p>MarkdownからはRubyを呼ぶことができないので、Markdownで書かれたレイアウトを使うことはできません。しかしながら、<code>:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>Textile テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://redcloth.org/" title="RedCloth">RedCloth</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.textile</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>textile :index, :layout_engine => :erb</tt></td>
  </tr>
</table>

<p>Textileからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:overview</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_textile'>textile</span><span class='lparen'>(</span><span class='symbol'>:introduction</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
</code></pre>

<p>ノート: 他のテンプレート内で<code>textile</code>メソッドを呼び出せます。</p>

<pre class="code ruby"><code class="ruby">%h1 Hello From Haml!
%p= textile(:greetings)
</code></pre>

<p>TexttileからはRubyを呼ぶことができないので、Textileで書かれたレイアウトを使うことはできません。しかしながら、<code>:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>RDoc テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://rdoc.sourceforge.net/" title="RDoc">RDoc</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.rdoc</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>rdoc :README, :layout_engine => :erb</tt></td>
  </tr>
</table>

<p>RDocからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:overview</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_rdoc'>rdoc</span><span class='lparen'>(</span><span class='symbol'>:introduction</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
</code></pre>

<p>ノート: 他のテンプレート内で<code>rdoc</code>メソッドを呼び出せます。</p>

<pre class="code ruby"><code class="ruby">%h1 Hello From Haml!
%p= rdoc(:greetings)
</code></pre>

<p>RDocからはRubyを呼ぶことができないので、RDocで書かれたレイアウトを使うことはできません。しかしながら、<code>:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>AsciiDoc テンプレート</h4>

<table>
 <tr>
   <td>依存</td>
   <td><a href="http://asciidoctor.org/" title="Asciidoctor">Asciidoctor</a></td>
 </tr>
 <tr>
   <td>ファイル拡張子</td>
   <td><tt>.asciidoc</tt>, <tt>.adoc</tt> and <tt>.ad</tt></td>
 </tr>
 <tr>
   <td>例</td>
   <td><tt>asciidoc :README, :layout_engine => :erb</tt></td>
 </tr>
</table>

<p>AsciiDocテンプレートからRubyのメソッドを直接呼び出すことができないため、ほぼ全ての場合にlocalsを指定する必要があるでしょう。</p>

<h4>Radius テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/jlong/radius" title="Radius">Radius</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.radius</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>radius :index, :locals => { :key => 'value' }</tt></td>
  </tr>
</table>

<p>RadiusテンプレートからRubyのメソッドを直接呼び出すことができないため、ほぼ全ての場合にlocalsを指定する必要があるでしょう。</p>

<h4>Markaby テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://markaby.github.com/" title="Markaby">Markaby</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.mab</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>markaby { h1 "Welcome!" }</tt></td>
  </tr>
</table>

<p>インラインテンプレート用にブロックを取ることもできます（例を参照）。</p>

<h4>RABL テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/nesquena/rabl" title="Rabl">Rabl</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.rabl</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>rabl :index</tt></td>
  </tr>
</table>

<h4>Slim テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://slim-lang.com/" title="Slim Lang">Slim Lang</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.slim</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>slim :index</tt></td>
  </tr>
</table>

<h4>Creole テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/minad/creole" title="Creole">Creole</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.creole</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>creole :wiki, :layout_engine => :erb</tt></td>
  </tr>
</table>

<p>Creoleからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:overview</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_creole'>creole</span><span class='lparen'>(</span><span class='symbol'>:introduction</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
</code></pre>

<p>ノート: 他のテンプレート内で<code>creole</code>メソッドを呼び出せます。</p>

<pre class="code ruby"><code class="ruby">%h1 Hello From Haml!
%p= creole(:greetings)
</code></pre>

<p>CreoleからはRubyを呼ぶことができないので、Creoleで書かれたレイアウトを使うことはできません。しかしながら、<code>:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>MediaWiki テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/nricciar/wikicloth" title="WikiCloth">WikiCloth</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.mediawiki</tt> および <tt>.mw</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>mediawiki :wiki, :layout_engine => :erb</tt></td>
  </tr>
</table>

<p>MediaWikiのテンプレートは直接メソッドから呼び出したり、ローカル変数を通すことはできません。それゆえに、通常は別のレンダリングエンジンと組み合わせて利用します。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:overview</span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:text</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_mediawiki'>mediawiki</span><span class='lparen'>(</span><span class='symbol'>:introduction</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
</code></pre>

<p>ノート: 他のテンプレートから部分的に<code>mediawiki</code>メソッドを呼び出すことも可能です。</p>

<h4>CoffeeScript テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="https://github.com/josh/ruby-coffee-script" title="Ruby CoffeeScript">
        CoffeeScript
      </a> および
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        JavaScriptの起動方法
      </a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.coffee</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>coffee :index</tt></td>
  </tr>
</table>

<h4>Stylus テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="https://github.com/lucasmazza/ruby-stylus" title="Ruby Stylus">
        Stylus
      </a> および
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        JavaScriptの起動方法
      </a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.styl</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>stylus :index</tt></td>
  </tr>
</table>

<p>Stylusテンプレートを使えるようにする前に、まず<code>stylus</code>と<code>stylus/tilt</code>を読み込む必要があります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>stylus</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>stylus/tilt</span><span class='tstring_end'>'</span></span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_stylus'>stylus</span> <span class='symbol'>:example</span>
<span class='kw'>end</span>
</code></pre>

<h4>Yajl テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/brianmario/yajl-ruby" title="yajl-ruby">yajl-ruby</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.yajl</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td>
      <tt>
        yajl :index,
             :locals => { :key => 'qux' },
             :callback => 'present',
             :variable => 'resource'
      </tt>
    </td>
  </tr>
</table>

<p>テンプレートのソースはRubyの文字列として評価され、その結果のJSON変数は<code>#to_json</code>を使って変換されます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_json'>json</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:foo</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>bar</span><span class='tstring_end'>'</span></span> <span class='rbrace'>}</span>
<span class='id identifier rubyid_json'>json</span><span class='lbracket'>[</span><span class='symbol'>:baz</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_key'>key</span>
</code></pre>

<p><code>:callback</code>および<code>:variable</code>オプションは、レンダリングされたオブジェクトを装飾するために使うことができます。</p>

<pre class="code ruby"><code class="ruby">var resource = {&quot;foo&quot;:&quot;bar&quot;,&quot;baz&quot;:&quot;qux&quot;}; present(resource);
</code></pre>

<h4>WLang テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/blambeau/wlang/" title="wlang">wlang</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.wlang</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>wlang :index, :locals => { :key => 'value' }</tt></td>
  </tr>
</table>

<p>WLang内でのRubyメソッドの呼び出しは一般的ではないので、ほとんどの場合にlocalsを指定する必要があるでしょう。しかしながら、WLangで書かれたレイアウトは<code>yield</code>をサポートしています。</p>

<h3>テンプレート内での変数へのアクセス</h3>

<p>テンプレートはルーティングハンドラと同じコンテキストの中で評価されます。ルーティングハンドラでセットされたインスタンス変数はテンプレート内で直接使うことができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/:id</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='ivar'>@foo</span> <span class='op'>=</span> <span class='const'>Foo</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>id</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>%h1= @foo.name</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>また、ローカル変数のハッシュで明示的に指定することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/:id</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_foo'>foo</span> <span class='op'>=</span> <span class='const'>Foo</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>id</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>%h1= bar.name</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:locals</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:bar</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_foo'>foo</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>このやり方は他のテンプレート内で部分テンプレートとして表示する時に典型的に使用されます。</p>

<h3><code>yield</code>を伴うテンプレートとネストしたレイアウト</h3>

<p>レイアウトは通常、<code>yield</code>を呼ぶ単なるテンプレートに過ぎません。
そのようなテンプレートは、既に説明した<code>:template</code>オプションを通して使われるか、または次のようなブロックを伴ってレンダリングされます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:post</span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:index</span>
<span class='kw'>end</span>
</code></pre>

<p>このコードは、<code>erb :index, :layout =&gt; :post</code>とほぼ等価です。</p>

<p>レンダリングメソッドにブロックを渡すスタイルは、ネストしたレイアウトを作るために最も役立ちます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:main_layout</span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:admin_layout</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:user</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>これはまた次のより短いコードでも達成できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:admin_layout</span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='symbol'>:main_layout</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:user</span>
<span class='kw'>end</span>
</code></pre>

<p>現在、次のレンダリングメソッドがブロックを取れます: <code>erb</code>, <code>haml</code>,
<code>liquid</code>, <code>slim</code>, <code>wlang</code>。
また汎用の<code>render</code>メソッドもブロックを取れます。</p>

<h3>インラインテンプレート(Inline Templates)</h3>

<p>テンプレートはソースファイルの最後で定義することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra</span><span class='tstring_end'>'</span></span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='symbol'>:index</span>
<span class='kw'>end</span>

<span class='__end__'>__END__
</span></code></pre>

<p>ノート: Sinatraをrequireするソースファイル内で定義されたインラインテンプレートは自動的に読み込まれます。他のソースファイル内にインラインテンプレートがある場合には<code>enable :inline_templates</code>を明示的に呼んでください。</p>

<h3>名前付きテンプレート(Named Templates)</h3>

<p>テンプレートはトップレベルの<code>template</code>メソッドで定義することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_template'>template</span> <span class='symbol'>:layout</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%html\n  =yield\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_template'>template</span> <span class='symbol'>:index</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>%div.title Hello World!</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='symbol'>:index</span>
<span class='kw'>end</span>
</code></pre>

<p>「layout」というテンプレートが存在する場合、そのテンプレートファイルは他のテンプレートがレンダリングされる度に使用されます。<code>:layout =&gt; false</code>で個別に、または<code>set :haml, :layout =&gt; false</code>でデフォルトとして、レイアウトを無効にすることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_haml'>haml</span> <span class='symbol'>:index</span><span class='comma'>,</span> <span class='symbol'>:layout</span> <span class='op'>=&gt;</span> <span class='op'>!</span><span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_xhr?'>xhr?</span>
<span class='kw'>end</span>
</code></pre>

<h3>ファイル拡張子の関連付け</h3>

<p>任意のテンプレートエンジンにファイル拡張子を関連付ける場合は、<code>Tilt.register</code>を使います。例えば、Textileテンプレートに<code>tt</code>というファイル拡張子を使いたい場合は、以下のようにします。</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Tilt</span><span class='period'>.</span><span class='id identifier rubyid_register'>register</span> <span class='symbol'>:tt</span><span class='comma'>,</span> <span class='const'>Tilt</span><span class='lbracket'>[</span><span class='symbol'>:textile</span><span class='rbracket'>]</span>
</code></pre>

<h3>オリジナルテンプレートエンジンの追加</h3>

<p>まず、Tiltでそのエンジンを登録し、次にレンダリングメソッドを作ります。</p>

<pre class="code ruby"><code class="ruby"><span class='const'>Tilt</span><span class='period'>.</span><span class='id identifier rubyid_register'>register</span> <span class='symbol'>:myat</span><span class='comma'>,</span> <span class='const'>MyAwesomeTemplateEngine</span>

<span class='id identifier rubyid_helpers'>helpers</span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_myat'>myat</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span> <span class='id identifier rubyid_render'>render</span><span class='lparen'>(</span><span class='symbol'>:myat</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span> <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_myat'>myat</span> <span class='symbol'>:index</span>
<span class='kw'>end</span>
</code></pre>

<p>これは、<code>./views/index.myat</code>をレンダリングします。Tiltについての詳細は、<a href="https://github.com/rtomayko/tilt">https://github.com/rtomayko/tilt</a> を参照してください。</p>

<h2>フィルタ(Filters)</h2>

<p>beforeフィルタは、リクエストのルーティングと同じコンテキストで各リクエストの前に評価され、それによってリクエストとレスポンスを変更可能にします。フィルタ内でセットされたインスタンス変数はルーティングとテンプレートからアクセスすることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_before'>before</span> <span class='kw'>do</span>
  <span class='ivar'>@note</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hi!</span><span class='tstring_end'>'</span></span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_path_info'>path_info</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo/bar/baz</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo/*</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='ivar'>@note</span> <span class='comment'>#=&gt; 'Hi!'
</span>  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>splat</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='comment'>#=&gt; 'bar/baz'
</span><span class='kw'>end</span>
</code></pre>

<p>afterフィルタは、リクエストのルーティングと同じコンテキストで各リクエストの後に評価され、それによってこれもリクエストとレスポンスを変更可能にします。beforeフィルタとルーティング内でセットされたインスタンス変数はafterフィルタからアクセスすることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_after'>after</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_status'>status</span>
<span class='kw'>end</span>
</code></pre>

<p>ノート: <code>body</code>メソッドを使わずにルーティングから文字列を返すだけの場合、その内容はafterフィルタでまだ利用できず、その後に生成されることになります。</p>

<p>フィルタにはオプションとしてパターンを渡すことができ、この場合はリクエストのパスがパターンにマッチした場合にのみフィルタが評価されるようになります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_before'>before</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/protected/*</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_authenticate!'>authenticate!</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_after'>after</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/create/:slug</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_slug'>slug</span><span class='op'>|</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:last_slug</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_slug'>slug</span>
<span class='kw'>end</span>
</code></pre>

<p>ルーティング同様、フィルタもまた条件を取ることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_before'>before</span> <span class='symbol'>:agent</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>Songbird</span><span class='regexp_end'>/</span></span> <span class='kw'>do</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>

<span class='id identifier rubyid_after'>after</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/blog/*</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:host_name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>example.com</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<h2>ヘルパー(Helpers)</h2>

<p>トップレベルの<code>helpers</code>メソッドを使用してルーティングハンドラやテンプレートで使うヘルパーメソッドを定義できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_helpers'>helpers</span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_bar'>bar</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='rbrace'>}</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/:name</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_bar'>bar</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
<span class='kw'>end</span>
</code></pre>

<p>あるいは、ヘルパーメソッドをモジュール内で個別に定義することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>module</span> <span class='const'>FooUtils</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_foo'>foo</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='rbrace'>}</span><span class='tstring_content'>foo</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>module</span> <span class='const'>BarUtils</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_bar'>bar</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_name'>name</span><span class='rbrace'>}</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_helpers'>helpers</span> <span class='const'>FooUtils</span><span class='comma'>,</span> <span class='const'>BarUtils</span>
</code></pre>

<p>その効果は、アプリケーションクラスにモジュールをインクルードするのと同じです。</p>

<h3>セッションの使用</h3>

<p>セッションはリクエスト間での状態維持のために使用されます。その起動により、ユーザセッションごとに一つのセッションハッシュが与えられます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_enable'>enable</span> <span class='symbol'>:sessions</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/:value</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>value</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<p>ノート: <code>enable :sessions</code>は実際にはすべてのデータをクッキーに保持します。これは必ずしも期待通りのものにならないかもしれません（例えば、大量のデータを保持することでトラフィックが増大するなど）。Rackセッションミドルウェアの利用が可能であり、その場合は<code>enable :sessions</code>を呼ばずに、選択したミドルウェアを他のミドルウェアのときと同じようにして取り込んでください。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_use'>use</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Session</span><span class='op'>::</span><span class='const'>Pool</span><span class='comma'>,</span> <span class='symbol'>:expire_after</span> <span class='op'>=&gt;</span> <span class='int'>2592000</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>value = </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/:value</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:value</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>value</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<p>セキュリティ向上のため、クッキー内のセッションデータはセッション秘密鍵(session secret)で署名されます。Sinatraによりランダムな秘密鍵が個別に生成されます。しかし、この秘密鍵はアプリケーションの立ち上げごとに変わってしまうので、すべてのアプリケーションのインスタンスで共有できる秘密鍵をセットしたくなるかもしれません。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:session_secret</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>super secret</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>更に、設定変更をしたい場合は、<code>sessions</code>の設定においてオプションハッシュを保持することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:sessions</span><span class='comma'>,</span> <span class='symbol'>:domain</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>foo.com</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>foo.comのサブドメイン上のアプリ間でセッションを共有化したいときは、代わりにドメインの前に <em>.</em> を付けます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:sessions</span><span class='comma'>,</span> <span class='symbol'>:domain</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>.foo.com</span><span class='tstring_end'>'</span></span>
</code></pre>

<h3>停止(Halting)</h3>

<p>フィルタまたはルーティング内で直ちにリクエストを止める場合</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_halt'>halt</span>
</code></pre>

<p>この際、ステータスを指定することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_halt'>halt</span> <span class='int'>410</span>
</code></pre>

<p>body部を指定することも、</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_halt'>halt</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>ここにbodyを書く</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>ステータスとbody部を指定することも、</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_halt'>halt</span> <span class='int'>401</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>立ち去れ!</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>ヘッダを付けることもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_halt'>halt</span> <span class='int'>402</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Content-Type</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>text/plain</span><span class='tstring_end'>'</span></span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>リベンジ</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>もちろん、テンプレートを<code>halt</code>に結びつけることも可能です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_halt'>halt</span> <span class='id identifier rubyid_erb'>erb</span><span class='lparen'>(</span><span class='symbol'>:error</span><span class='rparen'>)</span>
</code></pre>

<h3>パッシング(Passing)</h3>

<p>ルーティングは<code>pass</code>を使って次のルーティングに飛ばすことができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/guess/:who</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_pass'>pass</span> <span class='kw'>unless</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>who</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Frank</span><span class='tstring_end'>'</span></span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>見つかっちゃった!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/guess/*</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>はずれです!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>ルーティングブロックからすぐに抜け出し、次にマッチするルーティングを実行します。マッチするルーティングが見当たらない場合は404が返されます。</p>

<h3>別ルーティングの誘発</h3>

<p><code>pass</code>を使ってルーティングを飛ばすのではなく、他のルーティングを呼んだ結果を得たいというときがあります。これを実現するには<code>call</code>を使えばいいです。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_call'>call</span> <span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PATH_INFO</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_status'>status</span><span class='comma'>,</span> <span class='id identifier rubyid_headers'>headers</span><span class='comma'>,</span> <span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:upcase</span><span class='rparen'>)</span><span class='rbracket'>]</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>ノート: 先の例において、テストを楽にしパフォーマンスを改善するには、<code>&quot;bar&quot;</code>を単にヘルパーに移し、<code>/foo</code>および<code>/bar</code>から使えるようにするのがいいです。</p>

<p>リクエストが、その複製物でない同じアプリケーションのインスタンスに送られるようにしたいときは、<code>call</code>に代えて<code>call!</code>を使ってください。</p>

<p><code>call</code>についての詳細はRackの仕様書を参照してください。</p>

<h3>ボディ、ステータスコードおよびヘッダの設定</h3>

<p>ステータスコードおよびレスポンスボディを、ルーティングブロックの戻り値にセットすることが可能であり、これは推奨されています。しかし、あるケースでは実行フローの任意のタイミングでボディをセットしたくなるかもしれません。<code>body</code>ヘルパーメソッドを使えばそれができます。そうすると、それ以降、ボディにアクセスするためにそのメソッドを使うことができるようになります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_body'>body</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_after'>after</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_body'>body</span>
<span class='kw'>end</span>
</code></pre>

<p>また、<code>body</code>にはブロックを渡すことができ、これはRackハンドラにより実行されることになります(これはストリーミングを実装するのに使われます。&quot;戻り値&quot;の項を参照してください。)</p>

<p>ボディと同様に、ステータスコードおよびヘッダもセットできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_status'>status</span> <span class='int'>418</span>
  <span class='id identifier rubyid_headers'>headers</span> \
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Allow</span><span class='tstring_end'>&quot;</span></span>   <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>BREW, POST, GET, PROPFIND, WHEN</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Refresh</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_body'>body</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>I'm a tea pot!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>引数を伴わない<code>body</code>、<code>headers</code>、<code>status</code>などは、それらの現在の値にアクセスするために使えます。</p>

<h3>ストリーミングレスポンス(Streaming Responses)</h3>

<p>レスポンスボディの部分を未だ生成している段階で、データを送り出したいということがあります。極端な例では、クライアントがコネクションを閉じるまでデータを送り続けたいことがあります。<code>stream</code>ヘルパーを使えば、独自ラッパーを作る必要はありません。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_stream'>stream</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_out'>out</span><span class='op'>|</span>
    <span class='id identifier rubyid_out'>out</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>それは伝 -\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_sleep'>sleep</span> <span class='float'>0.5</span>
    <span class='id identifier rubyid_out'>out</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> (少し待つ) \n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_sleep'>sleep</span> <span class='int'>1</span>
    <span class='id identifier rubyid_out'>out</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>- 説になる！\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>これはストリーミングAPI、<a href="http://dev.w3.org/html5/eventsource/">Server Sent Events</a>の実装を可能にし、<a href="http://en.wikipedia.org/wiki/WebSocket">WebSockets</a>の土台に使うことができます。また、一部のコンテンツが遅いリソースに依存しているときに、スループットを上げるために使うこともできます。</p>

<p>ノート: ストリーミングの挙動、特に並行リクエスト(cuncurrent requests)の数は、アプリケーションを提供するのに使われるWebサーバに強く依存します。WEBRickを含むいくつかのサーバは、ストリーミングを全くサポートしません。サーバがストリーミングをサポートしない場合、ボディは<code>stream</code>に渡されたブロックの実行が終了した後、一度に全部送られることになります。ストリーミングは、Shotgunを使った場合は全く動作しません。</p>

<p>オプション引数が<code>keep_open</code>にセットされている場合、ストリームオブジェクト上で<code>close</code>は呼ばれず、実行フローの任意の遅れたタイミングでユーザがこれを閉じることを可能にします。これはThinやRainbowsのようなイベント型サーバ上でしか機能しません。他のサーバでは依然ストリームは閉じられます。</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># ロングポーリング
</span>
<span class='id identifier rubyid_set'>set</span> <span class='symbol'>:server</span><span class='comma'>,</span> <span class='symbol'>:thin</span>
<span class='id identifier rubyid_connections'>connections</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/subscribe</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='comment'># サーバイベントにおけるクライアントの関心を登録
</span>  <span class='id identifier rubyid_stream'>stream</span><span class='lparen'>(</span><span class='symbol'>:keep_open</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_out'>out</span><span class='op'>|</span>
    <span class='id identifier rubyid_connections'>connections</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_out'>out</span>
    <span class='comment'># 死んでいるコネクションを排除
</span>    <span class='id identifier rubyid_connections'>connections</span><span class='period'>.</span><span class='id identifier rubyid_reject!'>reject!</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:closed?</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_post'>post</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/message</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_connections'>connections</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_out'>out</span><span class='op'>|</span>
    <span class='comment'># クライアントへ新規メッセージ到着の通知
</span>    <span class='id identifier rubyid_out'>out</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>message</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>

    <span class='comment'># クライアントへの再接続の指示
</span>    <span class='id identifier rubyid_out'>out</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>

  <span class='comment'># 肯定応答
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>message received</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h3>ロギング(Logging)</h3>

<p>リクエストスコープにおいて、<code>logger</code>ヘルパーは<code>Logger</code>インスタンスを作り出します。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_logger'>logger</span><span class='period'>.</span><span class='id identifier rubyid_info'>info</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>loading data</span><span class='tstring_end'>&quot;</span></span>
  <span class='comment'># ...
</span><span class='kw'>end</span>
</code></pre>

<p>このロガーは、自動でRackハンドラのロギング設定を参照します。ロギングが無効(disabled)にされている場合、このメソッドはダミーオブジェクトを返すので、ルーティングやフィルタにおいて特に心配することはありません。</p>

<p>ノート: ロギングは、<code>Sinatra::Application</code>に対してのみデフォルトで有効にされているので、<code>Sinatra::Base</code>を継承している場合は、ユーザがこれを有効化する必要があります。</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MyApp</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='id identifier rubyid_configure'>configure</span> <span class='symbol'>:production</span><span class='comma'>,</span> <span class='symbol'>:development</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_enable'>enable</span> <span class='symbol'>:logging</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>ロギングミドルウェアが設定されてしまうのを避けるには、<code>logging</code>設定を<code>nil</code>にセットします。しかしこの場合、<code>logger</code>が<code>nil</code>を返すことを忘れないように。よくあるユースケースは、オリジナルのロガーをセットしたいときです。Sinatraは、とにかく<code>env[&#39;rack.logger&#39;]</code>で見つかるものを使います。</p>

<h3>MIMEタイプ(Mime Types)</h3>

<p><code>send_file</code>か静的ファイルを使う時、SinatraがMIMEタイプを理解できない場合があります。その時は <code>mime_type</code> を使ってファイル拡張子毎に登録して下さい。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_mime_type'>mime_type</span> <span class='symbol'>:foo</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>text/foo</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>これは<code>content_type</code>ヘルパーで利用することができます:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_content_type'>content_type</span> <span class='symbol'>:foo</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>foo foo foo</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h3>URLの生成</h3>

<p>URLを生成するためには<code>url</code>ヘルパーメソッドが使えます。Hamlではこのようにします。</p>

<pre class="code ruby"><code class="ruby">%a{:href =&gt; url('/foo')} foo
</code></pre>

<p>これはリバースプロキシおよびRackルーティングを、それらがあれば考慮に入れます。</p>

<p>このメソッドには<code>to</code>というエイリアスがあります(以下の例を参照)。</p>

<h3>ブラウザリダイレクト(Browser Redirect)</h3>

<p><code>redirect</code> ヘルパーメソッドを使うことで、ブラウザをリダイレクトさせることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_redirect'>redirect</span> <span class='id identifier rubyid_to'>to</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='kw'>end</span>
</code></pre>

<p>他に追加されるパラメータは、<code>halt</code>に渡される引数と同様に取り扱われます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_redirect'>redirect</span> <span class='id identifier rubyid_to'>to</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='int'>303</span>
<span class='id identifier rubyid_redirect'>redirect</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>http://google.com</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wrong place, buddy</span><span class='tstring_end'>'</span></span>
</code></pre>

<p>また、<code>redirect back</code>を使えば、簡単にユーザが来たページへ戻るリダイレクトを作れます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;a href='/bar'&gt;do something&lt;/a&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_do_something'>do_something</span>
  <span class='id identifier rubyid_redirect'>redirect</span> <span class='id identifier rubyid_back'>back</span>
<span class='kw'>end</span>
</code></pre>

<p>redirectに引数を渡すには、それをクエリーに追加するか、</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_redirect'>redirect</span> <span class='id identifier rubyid_to'>to</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar?sum=42</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
</code></pre>

<p>または、セッションを使います。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_enable'>enable</span> <span class='symbol'>:sessions</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:secret</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>foo</span><span class='tstring_end'>'</span></span>
  <span class='id identifier rubyid_redirect'>redirect</span> <span class='id identifier rubyid_to'>to</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/bar</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:secret</span><span class='rbracket'>]</span>
<span class='kw'>end</span>
</code></pre>

<h3>キャッシュ制御(Cache Control)</h3>

<p>ヘッダを正しく設定することが、適切なHTTPキャッシングのための基礎となります。</p>

<p>キャッシュ制御ヘッダ(Cache-Control header)は、次のように簡単に設定できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_cache_control'>cache_control</span> <span class='symbol'>:public</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>キャッシュしました!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>ヒント: キャッシングをbeforeフィルタ内で設定します。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_before'>before</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_cache_control'>cache_control</span> <span class='symbol'>:public</span><span class='comma'>,</span> <span class='symbol'>:must_revalidate</span><span class='comma'>,</span> <span class='symbol'>:max_age</span> <span class='op'>=&gt;</span> <span class='int'>60</span>
<span class='kw'>end</span>
</code></pre>

<p><code>expires</code>ヘルパーを対応するヘッダに使っている場合は、キャッシュ制御は自動で設定されます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_before'>before</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_expires'>expires</span> <span class='int'>500</span><span class='comma'>,</span> <span class='symbol'>:public</span><span class='comma'>,</span> <span class='symbol'>:must_revalidate</span>
<span class='kw'>end</span>
</code></pre>

<p>キャッシュを適切に使うために、<code>etag</code>または<code>last_modified</code>を使うことを検討してください。これらのヘルパーを、重い仕事をさせる <em>前</em> に呼ぶことを推奨します。そうすれば、クライアントが既にキャッシュに最新版を持っている場合はレスポンスを直ちに破棄するようになります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/article/:id</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='ivar'>@article</span> <span class='op'>=</span> <span class='const'>Article</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>id</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_last_modified'>last_modified</span> <span class='ivar'>@article</span><span class='period'>.</span><span class='id identifier rubyid_updated_at'>updated_at</span>
  <span class='id identifier rubyid_etag'>etag</span> <span class='ivar'>@article</span><span class='period'>.</span><span class='id identifier rubyid_sha1'>sha1</span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:article</span>
<span class='kw'>end</span>
</code></pre>

<p>また、<a href="http://ja.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation">weak ETag</a>を使うこともできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_etag'>etag</span> <span class='ivar'>@article</span><span class='period'>.</span><span class='id identifier rubyid_sha1'>sha1</span><span class='comma'>,</span> <span class='symbol'>:weak</span>
</code></pre>

<p>これらのヘルパーは、キャッシングをしてくれませんが、必要な情報をキャッシュに与えてくれます。もし手早いリバースプロキシキャッシングの解決策をお探しなら、 <a href="https://github.com/rtomayko/rack-cache">rack-cache</a>を試してください。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rack/cache</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sinatra</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_use'>use</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Cache</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_cache_control'>cache_control</span> <span class='symbol'>:public</span><span class='comma'>,</span> <span class='symbol'>:max_age</span> <span class='op'>=&gt;</span> <span class='int'>36000</span>
  <span class='id identifier rubyid_sleep'>sleep</span> <span class='int'>5</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p><code>:static_cache_control</code>設定(以下を参照)を、キャッシュ制御ヘッダ情報を静的ファイルに追加するために使ってください。</p>

<p>RFC 2616によれば、アプリケーションは、If-MatchまたはIf-None-Matchヘッダが<code>*</code>に設定されている場合には、要求されたリソースが既に存在するか否かに応じて、異なる振る舞いをすべきとなっています。Sinatraは、getのような安全なリクエストおよびputのような冪等なリクエストは既に存在しているものとして仮定し、一方で、他のリソース(例えば、postリクエスト)は新たなリソースとして取り扱われるよう仮定します。この振る舞いは、<code>:new_resource</code>オプションを渡すことで変更できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/create</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_etag'>etag</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:new_resource</span> <span class='op'>=&gt;</span> <span class='kw'>true</span>
  <span class='const'>Article</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span>
  <span class='id identifier rubyid_erb'>erb</span> <span class='symbol'>:new_article</span>
<span class='kw'>end</span>
</code></pre>

<p>ここでもWeak ETagを使いたい場合は、<code>:kind</code>オプションを渡してください。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_etag'>etag</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:new_resource</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='symbol'>:kind</span> <span class='op'>=&gt;</span> <span class='symbol'>:weak</span>
</code></pre>

<h3>ファイルの送信</h3>

<p>ファイルを送信するには、<code>send_file</code>ヘルパーメソッドを使います。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_send_file'>send_file</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>foo.png</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>これはオプションを取ることもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_send_file'>send_file</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>foo.png</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:type</span> <span class='op'>=&gt;</span> <span class='symbol'>:jpg</span>
</code></pre>

<p>オプション一覧</p>

<dl>
  <dt>filename</dt>
    <dd>ファイル名。デフォルトは実際のファイル名。</dd>

  <dt>last_modified</dt>
    <dd>Last-Modifiedヘッダの値。デフォルトはファイルのmtime。</dd>

  <dt>type</dt>
    <dd>コンテンツの種類。設定がない場合、ファイル拡張子から類推される。</dd>

  <dt>disposition</dt>
    <dd>
      Content-Dispositionに使われる。許容値: <tt>nil</tt> (デフォルト)、
      <tt>:attachment</tt> および <tt>:inline</tt>
    </dd>

  <dt>length</dt>
    <dd>Content-Lengthヘッダ。デフォルトはファイルサイズ。</dd>

  <dt>status</dt>
    <dd>
      送られるステータスコード。静的ファイルをエラーページとして送るときに便利。

      Rackハンドラでサポートされている場合は、Rubyプロセスからのストリーミング以外の手段が使われる。このヘルパーメソッドを使うと、Sinatraは自動で範囲リクエスト(range requests)を扱う。
    </dd>
</dl>

<h3>リクエストオブジェクトへのアクセス</h3>

<p>受信するリクエストオブジェクトは、<code>request</code>メソッドを通じてリクエストレベル(フィルタ、ルーティング、エラーハンドラ)からアクセスすることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># アプリケーションが http://example.com/example で動作している場合
</span><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>text/css</span><span class='words_sep'> </span><span class='tstring_content'>text/html</span><span class='words_sep'> </span><span class='tstring_content'>application/javascript</span><span class='words_sep'>]</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_accept'>accept</span>              <span class='comment'># ['text/html', '*/*']
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_accept?'>accept?</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>text/xml</span><span class='tstring_end'>'</span></span>  <span class='comment'># true
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_preferred_type'>preferred_type</span><span class='lparen'>(</span><span class='id identifier rubyid_t'>t</span><span class='rparen'>)</span>   <span class='comment'># 'text/html'
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span>                <span class='comment'># クライアントによって送信されたリクエストボディ(下記参照)
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_scheme'>scheme</span>              <span class='comment'># &quot;http&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_script_name'>script_name</span>         <span class='comment'># &quot;/example&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_path_info'>path_info</span>           <span class='comment'># &quot;/foo&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span>                <span class='comment'># 80
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_request_method'>request_method</span>      <span class='comment'># &quot;GET&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_query_string'>query_string</span>        <span class='comment'># &quot;&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_content_length'>content_length</span>      <span class='comment'># request.bodyの長さ
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_media_type'>media_type</span>          <span class='comment'># request.bodyのメディアタイプ
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span>                <span class='comment'># &quot;example.com&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_get?'>get?</span>                <span class='comment'># true (他の動詞にも同種メソッドあり)
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_form_data?'>form_data?</span>          <span class='comment'># false
</span>  <span class='id identifier rubyid_request'>request</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>some_param</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>       <span class='comment'># some_param変数の値。[]はパラメータハッシュのショートカット
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_referrer'>referrer</span>            <span class='comment'># クライアントのリファラまたは'/'
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_user_agent'>user_agent</span>          <span class='comment'># ユーザエージェント (:agent 条件によって使用される)
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_cookies'>cookies</span>             <span class='comment'># ブラウザクッキーのハッシュ
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_xhr?'>xhr?</span>                <span class='comment'># Ajaxリクエストかどうか
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_url'>url</span>                 <span class='comment'># &quot;http://example.com/example/foo&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span>                <span class='comment'># &quot;/example/foo&quot;
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_ip'>ip</span>                  <span class='comment'># クライアントのIPアドレス
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_secure?'>secure?</span>             <span class='comment'># false (sslではtrueになる)
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_forwarded?'>forwarded?</span>          <span class='comment'># true (リバースプロキシの裏で動いている場合)
</span>  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span>                 <span class='comment'># Rackによって渡された生のenvハッシュ
</span><span class='kw'>end</span>
</code></pre>

<p><code>script_name</code>や<code>path_info</code>などのオプションは次のように利用することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_before'>before</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_path_info'>path_info</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>全てのリクエストはここに来る</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p><code>request.body</code>はIOまたはStringIOのオブジェクトです。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_post'>post</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/api</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_rewind'>rewind</span>  <span class='comment'># 既に読まれているときのため
</span>  <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span> <span class='id identifier rubyid_request'>request</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_data'>data</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h3>アタッチメント(Attachments)</h3>

<p><code>attachment</code>ヘルパーを使って、レスポンスがブラウザに表示されるのではなく、ディスクに保存されることをブラウザに対し通知することができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_attachment'>attachment</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>保存しました!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>ファイル名を渡すこともできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_attachment'>attachment</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>info.txt</span><span class='tstring_end'>&quot;</span></span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>保存しました!</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h3>日付と時刻の取り扱い</h3>

<p>Sinatraは<code>time_for</code>ヘルパーメソッドを提供しており、それは与えられた値からTimeオブジェクトを生成します。これはまた<code>DateTime</code>、<code>Date</code>および類似のクラスを変換できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_pass'>pass</span> <span class='kw'>if</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_time_for'>time_for</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Dec 23, 2012</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>まだ時間がある</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>このメソッドは、<code>expires</code>、<code>last_modified</code>といった種類のものの内部で使われています。そのため、アプリケーションにおいて、<code>time_for</code>をオーバーライドすることでそれらのメソッドの挙動を簡単に拡張できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_helpers'>helpers</span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_time_for'>time_for</span><span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:yesterday</span> <span class='kw'>then</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='int'>24</span><span class='op'>*</span><span class='int'>60</span><span class='op'>*</span><span class='int'>60</span>
    <span class='kw'>when</span> <span class='symbol'>:tomorrow</span>  <span class='kw'>then</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>+</span> <span class='int'>24</span><span class='op'>*</span><span class='int'>60</span><span class='op'>*</span><span class='int'>60</span>
    <span class='kw'>else</span> <span class='kw'>super</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_last_modified'>last_modified</span> <span class='symbol'>:yesterday</span>
  <span class='id identifier rubyid_expires'>expires</span> <span class='symbol'>:tomorrow</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<h3>テンプレートファイルの探索</h3>

<p><code>find_template</code>ヘルパーは、レンダリングのためのテンプレートファイルを見つけるために使われます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_find_template'>find_template</span> <span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_views'>views</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>foo</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='const'>Tilt</span><span class='lbracket'>[</span><span class='symbol'>:haml</span><span class='rbracket'>]</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_file'>file</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>could be </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_file'>file</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>この例はあまり有益ではありません。しかし、このメソッドを、独自の探索機構で働くようオーバーライドするなら有益になります。例えば、複数のビューディレクトリを使えるようにしたいときがあります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:views</span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>views</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>templates</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>

<span class='id identifier rubyid_helpers'>helpers</span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_find_template'>find_template</span><span class='lparen'>(</span><span class='id identifier rubyid_views'>views</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_engine'>engine</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
    <span class='const'>Array</span><span class='lparen'>(</span><span class='id identifier rubyid_views'>views</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_v'>v</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_engine'>engine</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>他の例としては、異なるエンジン用の異なるディレクトリを使う場合です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:views</span><span class='comma'>,</span> <span class='symbol'>:sass</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>views/sass</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:haml</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>templates</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:default</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>views</span><span class='tstring_end'>'</span></span>

<span class='id identifier rubyid_helpers'>helpers</span> <span class='kw'>do</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_find_template'>find_template</span><span class='lparen'>(</span><span class='id identifier rubyid_views'>views</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_engine'>engine</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
    <span class='id identifier rubyid__'>_</span><span class='comma'>,</span> <span class='id identifier rubyid_folder'>folder</span> <span class='op'>=</span> <span class='id identifier rubyid_views'>views</span><span class='period'>.</span><span class='id identifier rubyid_detect'>detect</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span><span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_engine'>engine</span> <span class='op'>==</span> <span class='const'>Tilt</span><span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_folder'>folder</span> <span class='op'>||=</span> <span class='id identifier rubyid_views'>views</span><span class='lbracket'>[</span><span class='symbol'>:default</span><span class='rbracket'>]</span>
    <span class='kw'>super</span><span class='lparen'>(</span><span class='id identifier rubyid_folder'>folder</span><span class='comma'>,</span> <span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_engine'>engine</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>これをエクステンションとして書いて、他の人と簡単に共有することもできます！</p>

<p>ノート: <code>find_template</code>はファイルが実際に存在するかのチェックをしませんが、与えられたブロックをすべての可能なパスに対し呼び出します。これがパフォーマンス上の問題にはならないのは、<code>render</code>はファイルを見つけると直ちに<code>break</code>を使うからです。また、テンプレートの場所（および内容）は、developmentモードでの起動でない限りはキャッシュされます。このことは、複雑なメソッド(a really crazy method)を書いた場合は記憶しておく必要があります。</p>

<h2>コンフィギュレーション(Configuration)</h2>

<p>どの環境でも起動時に１回だけ実行されます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span>
  <span class='comment'># １つのオプションをセット
</span>  <span class='id identifier rubyid_set'>set</span> <span class='symbol'>:option</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>value</span><span class='tstring_end'>'</span></span>

  <span class='comment'># 複数のオプションをセット
</span>  <span class='id identifier rubyid_set'>set</span> <span class='symbol'>:a</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span> <span class='symbol'>:b</span> <span class='op'>=&gt;</span> <span class='int'>2</span>

  <span class='comment'># `set :option, true`と同じ
</span>  <span class='id identifier rubyid_enable'>enable</span> <span class='symbol'>:option</span>

  <span class='comment'># `set :option, false`と同じ
</span>  <span class='id identifier rubyid_disable'>disable</span> <span class='symbol'>:option</span>

  <span class='comment'># ブロックを使って動的な設定をすることもできます。
</span>  <span class='id identifier rubyid_set'>set</span><span class='lparen'>(</span><span class='symbol'>:css_dir</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='id identifier rubyid_views'>views</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>css</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>環境設定(<code>RACK_ENV</code>環境変数)が<code>:production</code>に設定されている時だけ実行する方法:</p>

<pre class="code ruby"><code class="ruby">configure :production do
  ...
end
</code></pre>

<p>環境設定が<code>:production</code>か<code>:test</code>に設定されている時だけ実行する方法:</p>

<pre class="code ruby"><code class="ruby">configure :production, :test do
  ...
end
</code></pre>

<p>設定したオプションには<code>settings</code>からアクセスできます:</p>

<pre class="code ruby"><code class="ruby">configure do
  set :foo, 'bar'
end

get '/' do
  settings.foo? # =&gt; true
  settings.foo  # =&gt; 'bar'
  ...
end
</code></pre>

<h3>攻撃防御に対する設定</h3>

<p>Sinatraは、<a href="https://github.com/rkh/rack-protection#readme">Rack::Protection</a>を使って、アプリケーションを多発する日和見的攻撃から守っています。この挙動は簡単に無効化できます(これはアプリケーションを大量の脆弱性攻撃に晒すことになります)。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_disable'>disable</span> <span class='symbol'>:protection</span>
</code></pre>

<p>単一の防御層を外すためには、<code>protection</code>をオプションハッシュにセットします。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:protection</span><span class='comma'>,</span> <span class='symbol'>:except</span> <span class='op'>=&gt;</span> <span class='symbol'>:path_traversal</span>
</code></pre>

<p>また配列を渡して、複数の防御を無効にすることもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_set'>set</span> <span class='symbol'>:protection</span><span class='comma'>,</span> <span class='symbol'>:except</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='symbol'>:path_traversal</span><span class='comma'>,</span> <span class='symbol'>:session_hijacking</span><span class='rbracket'>]</span>
</code></pre>

<p>デフォルトでSinatraは、<code>:sessions</code>が有効になっている場合、セッションベースの防御だけを設定します。しかし、自身でセッションを設定したい場合があります。その場合は、<code>:session</code>オプションを渡すことにより、セッションベースの防御を設定することができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_use'>use</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Session</span><span class='op'>::</span><span class='const'>Pool</span>
<span class='id identifier rubyid_set'>set</span> <span class='symbol'>:protection</span><span class='comma'>,</span> <span class='symbol'>:session</span> <span class='op'>=&gt;</span> <span class='kw'>true</span>
</code></pre>

<h3>利用可能な設定</h3>

<dl>
  <dt>absolute_redirects</dt>
  <dd>
    無効のとき、Sinatraは相対リダイレクトを許容するが、RFC 2616 (HTTP 1.1)は絶対リダイレクトのみを許容するので、これには準拠しなくなる。
  </dd>
  <dd>
    アプリケーションが、適切に設定されていないリバースプロキシの裏で走っている場合は有効。ノート: <tt>url</tt>ヘルパーは、第２引数に<tt>false</tt>を渡さない限り、依然として絶対URLを生成する。
  </dd>
  <dd>デフォルトは無効。</dd>

  <dt>add_charset</dt>
  <dd>
    Mimeタイプ <tt>content_type</tt>ヘルパーが自動的にキャラクタセット情報をここに追加する。このオプションは書き換えるのではなく、値を追加するようにすること。
    <tt>settings.add_charset << "application/foobar"</tt>
  </dd>

  <dt>app_file</dt>
  <dd>
    メインのアプリケーションファイルのパスであり、プロジェクトのルート、viewsおよびpublicフォルダを見つけるために使われる。
  </dd>

  <dt>bind</dt>
  <dd>バインドするIPアドレス(デフォルト: `environment`がdevelopmentにセットされているときは、<tt>0.0.0.0</tt> <em>または</em> <tt>localhost</tt>)。ビルトインサーバでのみ使われる。</dd>

  <dt>default_encoding</dt>
  <dd>不明なときに仮定されるエンコーディング(デフォルトは<tt>"utf-8"</tt>)。</dd>

  <dt>dump_errors</dt>
  <dd>ログにおけるエラーの表示。</dd>

  <dt>environment</dt>
  <dd>
    現在の環境。デフォルトは<tt>ENV['RACK_ENV']</tt>、それが無い場合は<tt>"development"</tt>。
  </dd>

  <dt>logging</dt>
  <dd>ロガーの使用。</dd>

  <dt>lock</dt>
  <dd>
    各リクエスト周りのロックの配置で、Rubyプロセスごとにリクエスト処理を並行して走らせるようにする。
  </dd>
  <dd>アプリケーションがスレッドセーフでなければ有効。デフォルトは無効。</dd>

  <dt>method_override</dt>
  <dd>
    put/deleteフォームを、それらをサポートしないブラウザで使えるように<tt>_method</tt>のおまじないを使えるようにする。
  </dd>

  <dt>port</dt>
  <dd>待ち受けポート。ビルトインサーバのみで有効。</dd>

  <dt>prefixed_redirects</dt>
  <dd>
    絶対パスが与えられていないときに、リダイレクトに<tt>request.script_name</tt>を挿入するか否かの設定。これにより<tt>redirect '/foo'</tt>は、<tt>redirect to('/foo')</tt>のように振る舞う。デフォルトは無効。
  </dd>

  <dt>protection</dt>
  <dd>Web攻撃防御を有効にするか否かの設定。上述の攻撃防御の項を参照。</dd>

  <dt>public_dir</dt>
  <dd><tt>public_folder</tt>のエイリアス。以下を参照。</dd>

  <dt>public_folder</dt>
  <dd>
    publicファイルが提供されるディレクトリのパス。静的ファイルの提供が有効になっている場合にのみ使われる (以下の<tt>static</tt>設定を参照)。設定されていない場合、<tt>app_file</tt>設定から推定。
  </dd>

  <dt>reload_templates</dt>
  <dd>
    リクエスト間でテンプレートを再ロードするか否かの設定。developmentモードでは有効。
  </dd>

  <dt>root</dt>
  <dd>
    プロジェクトのルートディレクトリのパス。設定されていない場合、<tt>app_file</tt>設定から推定。
  </dd>

  <dt>raise_errors</dt>
  <dd>
    例外発生の設定(アプリケーションは止まる)。<tt>environment</tt>が<tt>"test"</tt>に設定されているときはデフォルトは有効。それ以外は無効。
  </dd>

  <dt>run</dt>
  <dd>
    有効のとき、SinatraがWebサーバの起動を取り扱う。rackupまたは他の手段を使うときは有効にしないこと。
  </dd>

  <dt>running</dt>
  <dd>ビルトインサーバが稼働中か？この設定を変更しないこと！</dd>

  <dt>server</dt>
  <dd>
    ビルトインサーバとして使用するサーバまたはサーバ群の指定。指定順位は優先度を表し、デフォルトはRuby実装に依存。
  </dd>

  <dt>sessions</dt>
  <dd>
    <tt>Rack::Session::Cookie</tt>を使ったクッキーベースのセッションサポートの有効化。詳しくは、'セッションの使用'の項を参照のこと。
  </dd>

  <dt>show_exceptions</dt>
  <dd>
    例外発生時にブラウザにスタックトレースを表示する。<tt>environment</tt>が<tt>"development"</tt>に設定されているときは、デフォルトで有効。それ以外は無効。
  </dd>
  <dd>
    また、<tt>:after_handler</tt>をセットすることができ、これにより、ブラウザにスタックトレースを表示する前に、アプリケーション固有のエラーハンドリングを起動させられる。
  </dd>

  <dt>static</dt>
  <dd>Sinatraが静的ファイルの提供を取り扱うかの設定。</dd>
  <dd>その取り扱いができるサーバを使う場合は無効。</dd>
  <dd>無効化でパフォーマンスは改善する</dd>
  <dd>
    クラッシックスタイルではデフォルトで有効。モジュラースタイルでは無効。
  </dd>

  <dt>static_cache_control</dt>
  <dd>
    Sinatraが静的ファイルを提供するときこれをセットして、レスポンスに<tt>Cache-Control</tt>ヘッダを追加するようにする。<tt>cache_control</tt>ヘルパーを使うこと。デフォルトは無効。
  </dd>
  <dd>
    複数の値をセットするときは明示的に配列を使う:
    <tt>set :static_cache_control, [:public, :max_age => 300]</tt>
  </dd>

  <dt>threaded</dt>
  <dd>
    <tt>true</tt>に設定されているときは、Thinにリクエストを処理するために<tt>EventMachine.defer</tt>を使うことを通知する。
  </dd>

  <dt>views</dt>
  <dd>
    ビューディレクトリのパス。設定されていない場合、<tt>app_file</tt>設定から推定する。
  </dd>

  <dt>x_cascade</dt>
  <dd>
    マッチするルーティングが無い場合に、X-Cascadeヘッダをセットするか否かの設定。デフォルトは<tt>true</tt>。
  </dd>
</dl>

<h2>環境設定(Environments)</h2>

<p>３種類の既定環境、<code>&quot;development&quot;</code>、<code>&quot;production&quot;</code>および<code>&quot;test&quot;</code>があります。環境は、<code>RACK_ENV</code>環境変数を通して設定できます。デフォルト値は、<code>&quot;development&quot;</code>です。<code>&quot;development&quot;</code>環境において、すべてのテンプレートは、各リクエスト間で再ロードされ、そして、特別の<code>not_found</code>および<code>error</code>ハンドラがブラウザにスタックトレースを表示します。<code>&quot;production&quot;</code>および<code>&quot;test&quot;</code>環境においては、テンプレートはデフォルトでキャッシュされます。</p>

<p>異なる環境を走らせるには、<code>RACK_ENV</code>環境変数を設定します。</p>

<pre class="code shell"><code class="shell">RACK_ENV=production ruby my_app.rb
</code></pre>

<p>既定メソッド、<code>development?</code>、<code>test?</code>および<code>production?</code>を、現在の環境設定を確認するために使えます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_development?'>development?</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>development!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>not development!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h2>エラーハンドリング(Error Handling)</h2>

<p>エラーハンドラはルーティングおよびbeforeフィルタと同じコンテキストで実行されます。すなわちこれは、<code>haml</code>、<code>erb</code>、<code>halt</code>といった便利なものが全て使えることを意味します。</p>

<h3>未検出(Not Found)</h3>

<p><code>Sinatra::NotFound</code>例外が発生したとき、またはレスポンスのステータスコードが404のときに、<code>not_found</code>ハンドラが発動します。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_not_found'>not_found</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>ファイルが存在しません</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<h3>エラー(Error)</h3>

<p><code>error</code>ハンドラはルーティングブロックまたはフィルタ内で例外が発生したときはいつでも発動します。例外オブジェクトはRack変数<code>sinatra.error</code>から取得できます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_error'>error</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>エラーが発生しました。 - </span><span class='tstring_end'>'</span></span> <span class='op'>+</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra.error</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
<span class='kw'>end</span>
</code></pre>

<p>エラーをカスタマイズする場合は、</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_error'>error</span> <span class='const'>MyCustomError</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>エラーメッセージ...</span><span class='tstring_end'>'</span></span> <span class='op'>+</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra.error</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span>
<span class='kw'>end</span>
</code></pre>

<p>と書いておいて、下記のように呼び出します。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>MyCustomError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>何かがまずかったようです</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>そうするとこうなります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_エラーメッセージ'>エラーメッセージ</span><span class='op'>...</span> <span class='id identifier rubyid_何かがまずかったようです'>何かがまずかったようです</span>
</code></pre>

<p>あるいは、ステータスコードに対応するエラーハンドラを設定することもできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_error'>error</span> <span class='int'>403</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Access forbidden</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/secret</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='int'>403</span>
<span class='kw'>end</span>
</code></pre>

<p>範囲指定もできます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_error'>error</span> <span class='int'>400</span><span class='op'>..</span><span class='int'>510</span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Boom</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>Sinatraを開発環境の下で実行している場合は、特別な<code>not_found</code>および<code>error</code>ハンドラが導入され、これは親切なスタックトレースと追加のデバッギング情報をブラウザに表示します。</p>

<h2>Rackミドルウェア(Rack Middleware)</h2>

<p>SinatraはRuby製Webフレームワークのミニマルな標準的インタフェースである<a href="http://rack.github.io/">Rack</a>上に構築されています。アプリケーションデベロッパーにとってRackにおける最も興味深い機能は、「ミドルウェア(middleware)」をサポートしていることであり、これは、サーバとアプリケーションとの間に置かれ、HTTPリクエスト/レスポンスを監視および/または操作することで、各種の汎用的機能を提供するコンポーネントです。</p>

<p>Sinatraはトップレベルの<code>use</code>メソッドを通して、Rackミドルウェアパイプラインの構築を楽にします。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>my_custom_middleware</span><span class='tstring_end'>'</span></span>

<span class='id identifier rubyid_use'>use</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Lint</span>
<span class='id identifier rubyid_use'>use</span> <span class='const'>MyCustomMiddleware</span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/hello</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hello World</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p><code>use</code>の文法は、<a href="http://rubydoc.info/github/rack/rack/master/Rack/Builder">Rack::Builder</a>DSLで定義されているそれ（rackupファイルで最もよく使われる）と同じです。例えば <code>use</code>メソッドは複数の引数、そしてブロックも取ることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_use'>use</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Auth</span><span class='op'>::</span><span class='const'>Basic</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='id identifier rubyid_password'>password</span><span class='op'>|</span>
  <span class='id identifier rubyid_username'>username</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>admin</span><span class='tstring_end'>'</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_password'>password</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>secret</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>Rackは、ロギング、デバッギング、URLルーティング、認証、セッション管理など、多様な標準的ミドルウェアを共に配布されています。Sinatraはその多くのコンポーネントを自動で使うよう基本設定されているため、通常、それらを<code>use</code>で明示的に指定する必要はありません。</p>

<p>便利なミドルウェアを以下で見つけられます。</p>

<p><a href="https://github.com/rack/rack/tree/master/lib/rack">rack</a>、
<a href="https://github.com/rack/rack-contrib#readm">rack-contrib</a>、
または<a href="https://github.com/rack/rack/wiki/List-of-Middleware">Rack wiki</a>。</p>

<h2>テスト(Testing)</h2>

<p>SinatraでのテストはRackベースのテストライブラリまたはフレームワークを使って書くことができます。<a href="http://rdoc.info/github/brynary/rack-test/master/frames">Rack::Test</a>をお薦めします。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>my_sinatra_app</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>minitest/autorun</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>rack/test</span><span class='tstring_end'>'</span></span>

<span class='kw'>class</span> <span class='const'>MyAppTest</span> <span class='op'>&lt;</span> <span class='const'>Minitest</span><span class='op'>::</span><span class='const'>Test</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Rack</span><span class='op'>::</span><span class='const'>Test</span><span class='op'>::</span><span class='const'>Methods</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_app'>app</span>
    <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Application</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_test_my_default'>test_my_default</span>
    <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_assert_equal'>assert_equal</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hello World!</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_last_response'>last_response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_test_with_params'>test_with_params</span>
    <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/meet</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Frank</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_assert_equal'>assert_equal</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hello Frank!</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='id identifier rubyid_last_response'>last_response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_test_with_rack_env'>test_with_rack_env</span>
    <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>HTTP_USER_AGENT</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Songbird</span><span class='tstring_end'>'</span></span>
    <span class='id identifier rubyid_assert_equal'>assert_equal</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Songbirdを使ってます!</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_last_response'>last_response</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>ノート: モジュラースタイルでSinatraを使う場合は、上記<code>Sinatra::Application</code>をアプリケーションのクラス名に置き換えてください。</p>

<h2>Sinatra::Base - ミドルウェア、ライブラリおよびモジュラーアプリ</h2>

<p>軽量なアプリケーションであれば、トップレベルでアプリケーションを定義していくことはうまくいきますが、再利用性可能なコンポーネント、例えばRackミドルウェア、RailsのMetal、サーバコンポーネントを含むシンプルなライブラリ、あるいはSinatraの拡張プログラムを構築するような場合、これは無視できない欠点を持つものとなります。トップレベルは、軽量なアプリケーションのスタイルにおける設定（例えば、単一のアプリケーションファイル、<code>./public</code>および<code>./views</code>ディレクトリ、ロギング、例外詳細ページなど）を仮定しています。そこで<code>Sinatra::Base</code>の出番です。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra/base</span><span class='tstring_end'>'</span></span>

<span class='kw'>class</span> <span class='const'>MyApp</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='id identifier rubyid_set'>set</span> <span class='symbol'>:sessions</span><span class='comma'>,</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_set'>set</span> <span class='symbol'>:foo</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>bar</span><span class='tstring_end'>'</span></span>

  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hello world!</span><span class='tstring_end'>'</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p><code>Sinatra::Base</code>のサブクラスで利用できるメソッドは、トップレベルDSLで利用できるものと全く同じです。ほとんどのトップレベルで記述されたアプリは、以下の２点を修正することで<code>Sinatra::Base</code>コンポーネントに変えることができます。</p>

<ul>
<li><code>sinatra</code>の代わりに<code>sinatra/base</code>を読み込む
(そうしない場合、SinatraのDSLメソッドの全てがmainの名前空間にインポートされます)</li>
<li>ルーティング、エラーハンドラ、フィルタ、オプションを<code>Sinatra::Base</code>のサブクラスに書く</li>
</ul>

<p><code>Sinatra::Base</code>はまっさらです。ビルトインサーバを含む、ほとんどのオプションがデフォルトで無効になっています。利用可能なオプションとその挙動の詳細については<a href="http://sinatra.github.com/configuration.html">Configuring Settings</a>(英語)をご覧下さい。</p>

<p>もしもクラシックスタイルと同じような挙動のアプリケーションをトップレベルで定義させる必要があれば、<code>Sinatra::Application</code>をサブクラス化させてください。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sinatra/base</span><span class='tstring_end'>&quot;</span></span>

<span class='kw'>class</span> <span class='const'>MyApp</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Application</span>
  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hello world!</span><span class='tstring_end'>'</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h3>モジュラースタイル vs クラッシックスタイル</h3>

<p>一般的認識と違って、クラッシックスタイルを使うことに問題はなにもありません。それがそのアプリケーションに合っているのであれば、モジュラーアプリケーションに移行する必要はありません。</p>

<p>モジュラースタイルを使わずにクラッシックスタイルを使った場合の一番の不利な点は、Rubyプロセスごとにただ一つのSinatraアプリケーションしか持てない点です。複数が必要な場合はモジュラースタイルに移行してください。モジュラースタイルとクラッシックスタイルを混合できないということはありません。</p>

<p>一方のスタイルから他方へ移行する場合、デフォルト設定がわずかに異なる点に注意が必要です。</p>

<table>
  <tr>
    <th>設定</th>
    <th>クラッシック</th>
    <th>モジュラー</th>
    <th>モジュラー</th>
  </tr>

  <tr>
    <td>app_file</td>
    <td>sinatraを読み込むファイル</td>
    <td>Sinatra::Baseをサブクラス化したファイル</td>
    <td>Sinatra::Applicationをサブクラス化したファイル</td>
  </tr>

  <tr>
    <td>run</td>
    <td>$0 == app_file</td>
    <td>false</td>
    <td>false</td>
  </tr>

  <tr>
    <td>logging</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>method_override</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>inline_templates</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>static</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>
</table>

<h3>モジュラーアプリケーションの提供</h3>

<p>モジュラーアプリケーションを開始、つまり<code>run!</code>を使って開始させる二種類のやり方があります。</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># my_app.rb
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra/base</span><span class='tstring_end'>'</span></span>

<span class='kw'>class</span> <span class='const'>MyApp</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='comment'># ... アプリケーションのコードを書く ...
</span>
  <span class='comment'># Rubyファイルが直接実行されたらサーバを立ち上げる
</span>  <span class='id identifier rubyid_run!'>run!</span> <span class='kw'>if</span> <span class='id identifier rubyid_app_file'>app_file</span> <span class='op'>==</span> <span class='gvar'>$0</span>
<span class='kw'>end</span>
</code></pre>

<p>として、次のように起動するか、</p>

<pre class="code shell"><code class="shell">ruby my_app.rb
</code></pre>

<p>または、Rackハンドラを使えるようにする<code>config.ru</code>ファイルを書いて、</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config.ru (rackupで起動)
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>./my_app</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_run'>run</span> <span class='const'>MyApp</span>
</code></pre>

<p>起動します。</p>

<pre class="code shell"><code class="shell">rackup -p 4567
</code></pre>

<h3>config.ruを用いたクラッシックスタイルアプリケーションの使用</h3>

<p>アプリケーションファイルと、</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app.rb
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra</span><span class='tstring_end'>'</span></span>

<span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>Hello world!</span><span class='tstring_end'>'</span></span>
<span class='kw'>end</span>
</code></pre>

<p>対応する<code>config.ru</code>を書きます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>./app</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_run'>run</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Application</span>
</code></pre>

<h3>config.ruはいつ使うのか？</h3>

<p><code>config.ru</code>ファイルは、以下の場合に適しています。</p>

<ul>
<li>異なるRackハンドラ(Passenger, Unicorn, Herokuなど)でデプロイしたいとき</li>
<li><code>Sinatra::Base</code>の複数のサブクラスを使いたいとき</li>
<li>Sinatraをミドルウェアとして利用し、エンドポイントとしては利用しないとき</li>
</ul>

<p><strong>モジュラースタイルに移行したという理由だけで、<code>config.ru</code>に移行する必要はなく、<code>config.ru</code>で起動するためにモジュラースタイルを使う必要はありません。</strong></p>

<h3>Sinatraのミドルウェアとしての利用</h3>

<p>Sinatraは他のRackミドルウェアを利用することができるだけでなく、
全てのSinatraアプリケーションは、それ自体ミドルウェアとして別のRackエンドポイントの前に追加することが可能です。</p>

<p>このエンドポイントには、別のSinatraアプリケーションまたは他のRackベースのアプリケーション(Rails/Ramaze/Camping/…)が用いられるでしょう。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra/base</span><span class='tstring_end'>'</span></span>

<span class='kw'>class</span> <span class='const'>LoginScreen</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='id identifier rubyid_enable'>enable</span> <span class='symbol'>:sessions</span>

  <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/login</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_haml'>haml</span> <span class='symbol'>:login</span> <span class='rbrace'>}</span>

  <span class='id identifier rubyid_post'>post</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/login</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>admin</span><span class='tstring_end'>'</span></span> <span class='kw'>and</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>password</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>admin</span><span class='tstring_end'>'</span></span>
      <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>user_name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_redirect'>redirect</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/login</span><span class='tstring_end'>'</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>MyApp</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='comment'># ミドルウェアはbeforeフィルタの前に実行される
</span>  <span class='id identifier rubyid_use'>use</span> <span class='const'>LoginScreen</span>

  <span class='id identifier rubyid_before'>before</span> <span class='kw'>do</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>user_name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_halt'>halt</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>アクセスは拒否されました。&lt;a href='/login'&gt;ログイン&lt;/a&gt;してください。</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>user_name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<h3>動的なアプリケーションの生成</h3>

<p>新しいアプリケーションを実行時に、定数に割り当てることなく生成したくなる場合があるでしょう。<code>Sinatra.new</code>を使えばそれができます。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra/base</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_my_app'>my_app</span> <span class='op'>=</span> <span class='const'>Sinatra</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hi</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
<span class='id identifier rubyid_my_app'>my_app</span><span class='period'>.</span><span class='id identifier rubyid_run!'>run!</span>
</code></pre>

<p>これは省略できる引数として、それが継承するアプリケーションを取ります。</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config.ru (rackupで起動)
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra/base</span><span class='tstring_end'>'</span></span>

<span class='id identifier rubyid_controller'>controller</span> <span class='op'>=</span> <span class='const'>Sinatra</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_enable'>enable</span> <span class='symbol'>:logging</span>
  <span class='id identifier rubyid_helpers'>helpers</span> <span class='const'>MyHelpers</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/a</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_run'>run</span> <span class='const'>Sinatra</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_controller'>controller</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>a</span><span class='tstring_end'>'</span></span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/b</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_run'>run</span> <span class='const'>Sinatra</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_controller'>controller</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>b</span><span class='tstring_end'>'</span></span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
<span class='kw'>end</span>
</code></pre>

<p>これは特にSinatraのextensionをテストするときや、Sinatraを自身のライブラリで利用する場合に役立ちます。</p>

<p>これはまた、Sinatraをミドルウェアとして利用することを極めて簡単にします。</p>

<pre class="code ruby"><code class="ruby">require 'sinatra/base'

use Sinatra do
  get('/') { ... }
end

run RailsProject::Application
</code></pre>

<h2>スコープとバインディング(Scopes and Binding)</h2>

<p>現在のスコープはどのメソッドや変数が利用可能かを決定します。</p>

<h3>アプリケーション/クラスのスコープ</h3>

<p>全てのSinatraアプリケーションはSinatra::Baseのサブクラスに相当します。
もしトップレベルDSLを利用しているならば(<code>require &#39;sinatra&#39;</code>)このクラスはSinatra::Applicationであり、
そうでなければ、あなたが明示的に作成したサブクラスです。
クラスレベルでは<code>get</code>や<code>before</code>のようなメソッドを持っています。
しかし<code>request</code>や<code>session</code>オブジェクトには、全てのリクエストに対する単一のアプリケーションクラスがあるだけなので、アクセスできません。</p>

<p><code>set</code>によって作られたオプションはクラスレベルのメソッドです。</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MyApp</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='comment'># アプリケーションスコープの中だよ!
</span>  <span class='id identifier rubyid_set'>set</span> <span class='symbol'>:foo</span><span class='comma'>,</span> <span class='int'>42</span>
  <span class='id identifier rubyid_foo'>foo</span> <span class='comment'># =&gt; 42
</span>
  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/foo</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
    <span class='comment'># もうアプリケーションスコープの中にいないよ!
</span>  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>次の場所ではアプリケーションスコープバインディングを持ちます。</p>

<ul>
<li>アプリケーションクラス本体</li>
<li>拡張によって定義されたメソッド</li>
<li><code>helpers</code>に渡されたブロック</li>
<li><code>set</code>の値として使われるProcまたはブロック</li>
<li><code>Sinatra.new</code>に渡されたブロック</li>
</ul>

<p>このスコープオブジェクト(クラス)は次のように利用できます。</p>

<ul>
<li>configureブロックに渡されたオブジェクト経由(<code>configure { |c| ... }</code>)</li>
<li>リクエストスコープの中での<code>settings</code></li>
</ul>

<h3>リクエスト/インスタンスのスコープ</h3>

<p>やってくるリクエストごとに、あなたのアプリケーションクラスの新しいインスタンスが作成され、全てのハンドラブロックがそのスコープで実行されます。
このスコープの内側からは<code>request</code>や<code>session</code>オブジェクトにアクセスすることができ、<code>erb</code>や<code>haml</code>のようなレンダリングメソッドを呼び出すことができます。
リクエストスコープの内側からは、<code>settings</code>ヘルパーによってアプリケーションスコープにアクセスすることができます。</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MyApp</span> <span class='op'>&lt;</span> <span class='const'>Sinatra</span><span class='op'>::</span><span class='const'>Base</span>
  <span class='comment'># アプリケーションスコープの中だよ!
</span>  <span class='id identifier rubyid_get'>get</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/define_route/:name</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span>
    <span class='comment'># '/define_route/:name'のためのリクエストスコープ
</span>    <span class='ivar'>@value</span> <span class='op'>=</span> <span class='int'>42</span>

    <span class='id identifier rubyid_settings'>settings</span><span class='period'>.</span><span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>name</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>do</span>
      <span class='comment'># &quot;/#{params['name']}&quot;のためのリクエストスコープ
</span>      <span class='ivar'>@value</span> <span class='comment'># =&gt; nil (not the same request)
</span>    <span class='kw'>end</span>

    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ルーティングが定義された!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>次の場所ではリクエストスコープバインディングを持ちます。</p>

<ul>
<li>get/head/post/put/delete/options/patch/link/unlink ブロック</li>
<li>before/after フィルタ</li>
<li>helper メソッド</li>
<li>テンプレート/ビュー</li>
</ul>

<h3>デリゲートスコープ</h3>

<p>デリゲートスコープは、単にクラススコープにメソッドを転送します。
しかしながら、クラスのバインディングを持っていないため、クラススコープと全く同じふるまいをするわけではありません。
委譲すると明示的に示されたメソッドのみが利用可能であり、またクラススコープと変数/状態を共有することはできません(注:
異なった<code>self</code>を持っています)。
<code>Sinatra::Delegator.delegate :method_name</code>を呼び出すことによってデリゲートするメソッドを明示的に追加することができます。</p>

<p>次の場所ではデリゲートスコープを持ちます。</p>

<ul>
<li>もし<code>require &quot;sinatra&quot;</code>しているならば、トップレベルバインディング</li>
<li><code>Sinatra::Delegator</code> mixinでextendされたオブジェクト</li>
</ul>

<p>コードをご覧ください: ここでは <a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/base.rb#L1609-1633">Sinatra::Delegator
mixin</a>は<a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/main.rb#L28-30">mainオブジェクトにextendされています</a>。</p>

<h2>コマンドライン</h2>

<p>Sinatraアプリケーションは直接実行できます。</p>

<pre class="code shell"><code class="shell">ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-o HOST] [-s HANDLER]
</code></pre>

<p>オプション:</p>

<pre class="code ruby"><code class="ruby"><span class='op'>-</span><span class='id identifier rubyid_h'>h</span> <span class='comment'># ヘルプ
</span><span class='op'>-</span><span class='id identifier rubyid_p'>p</span> <span class='comment'># ポート指定(デフォルトは4567)
</span><span class='op'>-</span><span class='id identifier rubyid_o'>o</span> <span class='comment'># ホスト指定(デフォルトは0.0.0.0)
</span><span class='op'>-</span><span class='id identifier rubyid_e'>e</span> <span class='comment'># 環境を指定 (デフォルトはdevelopment)
</span><span class='op'>-</span><span class='id identifier rubyid_s'>s</span> <span class='comment'># rackserver/handlerを指定 (デフォルトはthin)
</span><span class='op'>-</span><span class='id identifier rubyid_x'>x</span> <span class='comment'># mutex lockを付ける (デフォルトはoff)
</span></code></pre>

<h2>必要環境</h2>

<p>次のRubyバージョンが公式にサポートされています。</p>

<dl>
  <dt>Ruby 1.8.7</dt>
  <dd>
    1.8.7は完全にサポートされていますが、特にそれでなければならないという理由がないのであれば、アップグレードまたはJRubyまたはRubiniusへの移行を薦めます。1.8.7のサポートがSinatra 2.0の前に終わることはないでしょう。Ruby 1.8.6はサポート対象外です。
  </dd>

  <dt>Ruby 1.9.2</dt>
  <dd>
    1.9.2は完全にサポートされています。1.9.2p0は、Sinatraを起動したときにセグメントフォルトを引き起こすことが分かっているので、使わないでください。公式なサポートは、少なくともSinatra 1.5のリリースまでは続きます。
  </dd>

  <dt>Ruby 1.9.3</dt>
  <dd>
    1.9.3は完全にサポート、そして推奨されています。以前のバージョンからの1.9.3への移行は全セッションを無効にする点、覚えておいてください。
  </dd>

  <dt>Ruby 2.0.0</dt>
  <dd>
    2.0.0は完全にサポート、そして推奨されています。現在、その公式サポートを終了する計画はありません。
  </dd>

  <dt>Rubinius</dt>
  <dd>
    Rubiniusは公式にサポートされています(Rubinius >= 2.x)。
    <tt>gem install puma</tt>することが推奨されています。
  </dd>

  <dt>JRuby</dt>
  <dd>
    JRubyの最新安定版が公式にサポートされています。JRubyでC拡張を使うことは推奨されていません。
    <tt>gem install trinidad</tt>することが推奨されています。
  </dd>
</dl>

<p>開発チームは常に最新となるRubyバージョンに注視しています。</p>

<p>次のRuby実装は公式にはサポートされていませんが、Sinatraが起動すると報告されています。</p>

<ul>
<li>JRubyとRubiniusの古いバージョン</li>
<li>Ruby Enterprise Edition</li>
<li>MacRuby, Maglev, IronRuby</li>
<li>Ruby 1.9.0と1.9.1 (これらの使用はお薦めしません)</li>
</ul>

<p>公式サポートをしないという意味は、問題がそこだけで起こり、サポートされているプラットフォーム上では起きない場合に、開発チームはそれはこちら側の問題ではないとみなすということです。</p>

<p>開発チームはまた、ruby-head(最新となる2.1.0)に対しCIを実行していますが、それが一貫して動くようになるまで何も保証しません。2.1.0が完全にサポートされればその限りではありません。</p>

<p>Sinatraは、利用するRuby実装がサポートしているオペレーティングシステム上なら動作するはずです。</p>

<p>MacRubyを使う場合は、<code>gem install control_tower</code>してください。</p>

<p>Sinatraは現在、Cardinal、SmallRuby、BlueRubyまたは1.8.7以前のバージョンのRuby上では動作しません。</p>

<h2>最新開発版</h2>

<p>Sinatraの最新開発版のコードを使いたい場合は、マスターブランチに対してアプリケーションを走らせて構いません。ある程度安定しています。また、適宜プレリリース版gemをpushしているので、</p>

<pre class="code shell"><code class="shell">gem install sinatra --pre
</code></pre>

<p>すれば、最新の機能のいくつかを利用できます。</p>

<h3>Bundlerを使う場合</h3>

<p>最新のSinatraでアプリケーションを動作させたい場合には、<a href="http://gembundler.com/">Bundler</a>を使うのがお薦めのやり方です。</p>

<p>まず、Bundlerがなければそれをインストールします。</p>

<pre class="code shell"><code class="shell">gem install bundler
</code></pre>

<p>そして、プロジェクトのディレクトリで、<code>Gemfile</code>を作ります。</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>https://rubygems.org</span><span class='tstring_end'>'</span></span>
<span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>sinatra</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='symbol'>:github</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sinatra/sinatra</span><span class='tstring_end'>&quot;</span></span>

<span class='comment'># 他の依存ライブラリ
</span><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>haml</span><span class='tstring_end'>'</span></span>                    <span class='comment'># Hamlを使う場合
</span><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>activerecord</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>~&gt; 3.0</span><span class='tstring_end'>'</span></span>  <span class='comment'># ActiveRecord 3.xが必要かもしれません
</span></code></pre>

<p>ノート: <code>Gemfile</code>にアプリケーションの依存ライブラリのすべてを並べる必要があります。しかし、Sinatraが直接依存するもの(RackおよびTile)はBundlerによって自動的に取り込まれ、追加されます。</p>

<p>これで、以下のようにしてアプリケーションを起動することができます。</p>

<pre class="code shell"><code class="shell">bundle exec ruby myapp.rb
</code></pre>

<h3>直接組み込む場合</h3>

<p>ローカルにクローンを作って、<code>sinatra/lib</code>ディレクトリを<code>$LOAD_PATH</code>に追加してアプリケーションを起動します。</p>

<pre class="code shell"><code class="shell">cd myapp
git clone git://github.com/sinatra/sinatra.git
ruby -I sinatra/lib myapp.rb
</code></pre>

<p>追ってSinatraのソースを更新する方法。</p>

<pre class="code shell"><code class="shell">cd myapp/sinatra
git pull
</code></pre>

<h3>グローバル環境にインストールする場合</h3>

<p>Sinatraのgemを自身でビルドすることもできます。</p>

<pre class="code shell"><code class="shell">git clone git://github.com/sinatra/sinatra.git
cd sinatra
rake sinatra.gemspec
rake install
</code></pre>

<p>gemをルートとしてインストールする場合は、最後のステップはこうなります。</p>

<pre class="code shell"><code class="shell">sudo rake install
</code></pre>

<h2>バージョニング(Versioning)</h2>

<p>Sinatraは、<a href="http://semver.org/">Semantic Versioning</a>におけるSemVerおよびSemVerTagの両方に準拠しています。</p>

<h2>参考文献</h2>

<ul>
<li><a href="http://sinatra.github.com/">プロジェクトサイト</a> - ドキュメント、ニュース、他のリソースへのリンクがあります。</li>
<li><a href="http://sinatra.github.com/contributing.html">プロジェクトに参加(貢献)する</a> - バグレポート パッチの送信、サポートなど</li>
<li><a href="http://github.com/sinatra/sinatra/issues">Issue tracker</a></li>
<li><a href="http://twitter.com/sinatra">Twitter</a></li>
<li><a href="http://groups.google.com/group/sinatrarb/topics">メーリングリスト</a></li>
<li><a href="http://freenode.net%E4%B8%8A%E3%81%AEIRC:">http://freenode.net上のIRC:</a> <a href="irc://chat.freenode.net/#sinatra">#sinatra</a></li>
<li><a href="https://github.com/sinatra/sinatra-book/">Sinatra Book</a> クックブック、チュートリアル</li>
<li><a href="http://recipes.sinatrarb.com/">Sinatra Recipes</a> コミュニティによるレシピ集</li>
<li><a href="http://rubydoc.info%E4%B8%8A%E3%81%AEAPI%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88:">http://rubydoc.info上のAPIドキュメント:</a> <a href="http://rubydoc.info/gems/sinatra">最新版(latest release)用</a>または<a href="http://rubydoc.info/github/sinatra/sinatra">現在のHEAD用</a></li>
<li><a href="http://travis-ci.org/sinatra/sinatra">CIサーバ</a></li>
<li><a href="http://route477.net/w/RackReferenceJa.html">Greenbear Laboratory Rack日本語マニュアル</a></li>
</ul>
</div></div>

    <div id="footer">
  Generated on Thu Sep 24 16:24:26 2015 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-1.9.3).
</div>

  </body>
</html>